# 数据模型设计

> **最后更新**: 2026-01-29  
> **同步状态**: ✅ 已与 `docs/api.yml` 和代码实现对齐

## 模型分层（DDD 视角）

项目采用 DDD 分层，数据模型分布在不同层级：

```
file-srv-core/
├── application/
│   ├── entrypoint/model/            # API 层 DTO（HTTP 请求/响应）
│   │   ├── FileInfoResponse.java    # 文件信息响应
│   │   ├── TaskResponse.java        # 任务响应（sealed）
│   │   ├── MetaQueryRequest.java    # 元数据查询请求
│   │   └── PartETag.java            # 分片 ETag
│   └── service/dto/                 # 应用服务层 DTO
│       ├── FileInfoDto.java
│       └── TaskInfoDto.java
│
├── domain/                          # 领域层（核心业务对象）
│   ├── files/
│   │   ├── FileReference.java       # 文件引用（聚合根）
│   │   ├── FileInfo.java            # 物理文件实体
│   │   └── FileStatus.java          # 文件状态枚举
│   ├── storage/
│   │   ├── StorageNode.java         # 存储节点
│   │   ├── StorageCopy.java         # 存储副本
│   │   └── StoragePolicy.java       # 存储策略
│   └── tasks/
│       ├── TaskAggregate.java       # 任务聚合根
│       └── PartInfo.java            # 分片信息

file-srv-common/
└── vo/                              # 共享 ValueObject（跨层复用）
    ├── file/
    │   ├── FileIdentity.java        # 文件身份
    │   ├── StorageRef.java          # 存储引用
    │   └── AccessControl.java       # 访问控制
    ├── audit/
    │   ├── OwnerInfo.java           # 所有者信息
    │   └── AuditInfo.java           # 审计信息
    └── task/
        ├── TaskSummary.java         # 任务摘要
        ├── FileRequest.java         # 文件请求
        ├── UploadProgress.java      # 上传进度
        ├── FailureDetail.java       # 失败详情
        └── DerivedFile.java         # 衍生文件
```

## 共享 ValueObject (file-srv-common/vo/)

### FileIdentity - 文件身份
```java
@Builder
public record FileIdentity(
    @JsonProperty("fkey") String fKey,  // 用户文件唯一标识
    String fileName,                     // 文件名
    String fileType,                     // MIME 类型
    Long fileSize,                       // 文件大小（字节）
    String eTag                          // 文件 ETag/校验和
) {}
```

### StorageRef - 存储引用
```java
@Builder
public record StorageRef(
    String storageType,      // 存储类型（HCS/S3/LOCAL）
    String location,         // 存储位置/桶名
    String path,             // 对象路径
    String checksum,         // 校验和
    String fileUrl           // 访问 URL
) {}
```

### AccessControl - 访问控制
```java
@Builder
public record AccessControl(
    @JsonProperty("public") Boolean isPublic,        // 是否公开
    String tags,                                     // 标签（逗号分隔）
    @JsonProperty("customMetaData") Map<String, String> customMetadata  // 自定义元数据
) {}
```

### OwnerInfo - 所有者信息
```java
@Builder
public record OwnerInfo(
    String createdBy,        // 创建者 ID
    String creatorName       // 创建者名称
) {}
```

### AuditInfo - 审计信息
```java
@Builder
public record AuditInfo(
    OffsetDateTime createdAt,  // 创建时间
    OffsetDateTime updatedAt   // 更新时间
) {}
```

### TaskSummary - 任务摘要
```java
@Builder
public record TaskSummary(
    String taskId,           // 任务 ID
    String uploadId,         // 存储侧上传 ID
    Instant createdAt,       // 创建时间
    Instant expiresAt        // 过期时间
) {}
```

### FileRequest - 文件请求
```java
@Builder
public record FileRequest(
    String filename,         // 文件名
    String contentType,      // MIME 类型
    Long size,               // 文件大小
    @JsonProperty("eTag") String eTag,  // ETag/校验和
    String location          // 存储位置
) {}
```

### UploadProgress - 上传进度
```java
@Builder
public record UploadProgress(
    int totalParts,          // 预期分片总数
    int uploadedParts,       // 已上传分片数
    long uploadedBytes,      // 已上传字节数
    List<PartInfo> parts     // 分片详情列表
) {
    @Builder
    public record PartInfo(
        int partNumber,      // 分片编号（1-based）
        long size,           // 分片大小
        @JsonProperty("eTag") String eTag,  // 分片 ETag
        Instant uploadedAt   // 上传时间
    ) {}
}
```

### FailureDetail - 失败详情
```java
@Builder
public record FailureDetail(
    String errorCode,        // 错误码
    String errorMessage,     // 错误信息
    Instant failedAt         // 失败时间
) {}
```

### DerivedFile - 衍生文件
```java
@Builder
public record DerivedFile(
    String type,             // 衍生类型（THUMBNAIL/PREVIEW）
    String fileId,           // 衍生文件 ID
    String path,             // 存储路径
    String contentType,      // MIME 类型
    Long size                // 文件大小
) {}
```

## API 层响应模型 (application/entrypoint/model/)

### FileInfoResponse - 文件信息响应
```java
@Builder
public record FileInfoResponse(
    @JsonUnwrapped FileIdentity identity,     // 文件身份
    @JsonUnwrapped StorageRef storageRef,     // 存储引用
    @JsonUnwrapped OwnerInfo owner,           // 所有者
    @JsonUnwrapped AuditInfo audit,           // 审计信息
    @JsonUnwrapped AccessControlView access   // 访问控制视图
) {}
```

### TaskResponse - 任务响应（sealed interface）
```java
@JsonTypeInfo(use = JsonTypeInfo.Id.NAME, property = "status")
public sealed interface TaskResponse {
    
    record Pending(
        @JsonUnwrapped TaskSummary summary,
        @JsonUnwrapped FileRequest request
    ) implements TaskResponse {}
    
    record InProgress(
        @JsonUnwrapped TaskSummary summary,
        @JsonUnwrapped FileRequest request,
        @JsonUnwrapped UploadProgress progress
    ) implements TaskResponse {}
    
    record Completed(
        @JsonUnwrapped TaskSummary summary,
        FileInfoResponse file,
        List<DerivedFile> derivedFiles
    ) implements TaskResponse {}
    
    record Failed(
        @JsonUnwrapped TaskSummary summary,
        @JsonUnwrapped FileRequest request,
        @JsonUnwrapped UploadProgress progress,
        @JsonUnwrapped FailureDetail failure
    ) implements TaskResponse {}
    
    record Aborted(
        @JsonUnwrapped TaskSummary summary,
        @JsonUnwrapped FileRequest request,
        Instant abortedAt,
        String reason
    ) implements TaskResponse {}
}
```

## 领域层模型 (domain/)

### FileReference - 文件引用（聚合根）
```java
public record FileReference(
    String fKey,             // 用户文件唯一标识（UUID v7）
    String contentHash,      // 关联物理文件（xxHash-64）
    String filename,         // 用户可见文件名
    String contentType,      // MIME 类型
    Long size,               // 文件大小
    String eTag,             // 文件 ETag/校验和
    OwnerInfo owner,         // 所有者
    AccessControl access,    // 访问控制
    AuditInfo audit          // 审计信息
) {
    // 工厂方法
    public static FileReference create(String filename, String contentType, Long size, OwnerInfo owner);
    
    // 绑定内容
    public FileReference bindContent(String contentHash, String eTag);
    
    // 更新访问控制
    public FileReference withAccess(AccessControl newAccess);
}
```

### FileInfo - 物理文件实体
```java
public class FileInfo {
    private String contentHash;      // xxHash-64
    private Long size;               // 文件大小
    private String contentType;      // MIME 类型
    private Integer refCount;        // 引用计数
    private FileStatus status;       // 文件状态
    private List<StorageCopy> copies;  // 存储副本列表
    private Instant createdAt;       // 创建时间
}
```

### TaskAggregate - 任务聚合根
```java
public class TaskAggregate {
    private String taskId;           // 任务 ID
    private String sessionId;        // 存储侧会话 ID
    private String filename;         // 文件名
    private String contentType;      // MIME 类型
    private Long totalSize;          // 文件大小
    private TaskStatus status;       // 任务状态
    private List<PartInfo> parts;    // 已上传分片
    private Instant createdAt;       // 创建时间
    private Instant expiresAt;       // 过期时间
}
```

## 持久化实体 (infra/persistence/entity/)

### FileReferenceEntity - 文件引用实体
```java
@Entity
@Table(name = "file_reference")
public class FileReferenceEntity {
    @Id
    @Column(name = "f_key", length = 36)
    private String fKey;
    
    @Column(name = "content_hash", length = 32)
    private String contentHash;
    
    @Column(name = "filename", nullable = false, length = 255)
    private String filename;
    
    @Column(name = "content_type", length = 128)
    private String contentType;
    
    @Column(name = "size")
    private Long size;
    
    @Column(name = "etag", length = 128)
    private String eTag;
    
    @Column(name = "owner_id", length = 64)
    private String ownerId;
    
    @Column(name = "owner_name", length = 128)
    private String ownerName;
    
    @Enumerated(EnumType.STRING)
    @Column(name = "status", length = 16)
    private FileStatus status;
    
    @Column(name = "is_public")
    private Boolean isPublic;
    
    @Column(name = "created_at")
    private OffsetDateTime createdAt;
    
    @Column(name = "updated_at")
    private OffsetDateTime updatedAt;
}
```

### FileInfoEntity - 物理文件实体
```java
@Entity
@Table(name = "file_info")
public class FileInfoEntity {
    @Id
    @Column(name = "content_hash", length = 32)
    private String contentHash;
    
    @Column(name = "size")
    private Long size;
    
    @Column(name = "content_type", length = 128)
    private String contentType;
    
    @Column(name = "ref_count")
    private Integer refCount;
    
    @Enumerated(EnumType.STRING)
    @Column(name = "status", length = 16)
    private FileStatus status;
    
    @ElementCollection
    @CollectionTable(name = "storage_copy")
    private List<StorageCopyEmbeddable> copies;
    
    @Column(name = "created_at")
    private Instant createdAt;
}
```

## JSON 序列化说明

### @JsonProperty 注解用途

用于统一 API 响应字段名与 OpenAPI 规范：

| Java 字段 | JSON 字段 | 说明 |
|----------|----------|------|
| `fKey` | `fkey` | 文件唯一标识（小写） |
| `eTag` | `eTag` | 保持驼峰式（HTTP 标准） |
| `isPublic` | `public` | 布尔属性映射为 JSON 关键字 |
| `customMetadata` | `customMetaData` | 与 API 定义对齐 |

### @JsonUnwrapped 注解

用于扁平化嵌套对象，减少 JSON 层级：

```java
// Java 对象
record FileInfoResponse(
    @JsonUnwrapped FileIdentity identity,
    @JsonUnwrapped OwnerInfo owner
)

// JSON 输出（扁平化）
{
  "fkey": "xxx",
  "fileName": "test.png",
  "createdBy": "user1",
  "creatorName": "User One"
}
```

## 字段命名规范

### Java 代码层
- **变量名**: 驼峰式 `camelCase`（如 `fileName`, `contentType`）
- **常量名**: 大写下划线 `UPPER_SNAKE_CASE`
- **类名**: 帕斯卡式 `PascalCase`

### API 层（JSON）
- **普通字段**: 驼峰式（如 `fileName`, `fileType`）
- **特殊字段**: 根据 API 规范调整
  - `fkey` - 全小写（历史兼容）
  - `eTag` - HTTP 标准写法
  - `public` - JSON 关键字

### 数据库层
- **表名**: 下划线分隔 `snake_case`（如 `file_reference`, `upload_task`）
- **列名**: 下划线分隔（如 `f_key`, `content_hash`, `created_at`）

## 索引建议

| 表 | 索引 | 用途 |
|---|------|------|
| `file_reference` | `pk_f_key` (primary key) | fKey 主键 |
| `file_reference` | `idx_content_hash` | 关联物理文件 |
| `file_reference` | `idx_owner_created` | 按所有者+时间查询 |
| `file_info` | `pk_content_hash` (primary key) | contentHash 主键 |
| `file_info` | `idx_status_created` | 状态+时间查询 |
| `storage_node` | `pk_node_id` (primary key) | nodeId 主键 |
| `storage_copy` | `uk_file_node` (unique) | 文件+节点唯一索引 |

## Redis 缓存键设计

| 键 | 值 | TTL | 用途 |
|---|-----|-----|------|
| `file:ref:{fkey}` | FileReference JSON | 30min | 文件引用缓存 |
| `file:info:{hash}` | FileInfo JSON | 1h | 物理文件缓存 |
| `upload:task:{taskId}` | TaskAggregate JSON | 24h | 任务状态缓存 |

## 数据一致性策略

### 写路径
1. **文件上传**: 
   - 创建 FileReference（PENDING）
   - 上传存储 → 计算 eTag/contentHash
   - 创建/更新 FileInfo（引用计数+1）
   - 更新 FileReference（ACTIVE，绑定 contentHash + eTag）
   - 失效缓存

### 读路径
- **L1**: Caffeine（本地缓存）
- **L2**: Redis（分布式缓存）
- **L3**: PostgreSQL（持久化）

### 删除路径
1. 标记 FileReference（DELETED）
2. FileInfo 引用计数 -1
3. 若 refCount = 0，异步删除存储
4. 清理缓存

---

**设计原则**:
1. ✅ ValueObject 跨层复用（不可变，无逻辑）
2. ✅ DTO 按层定义（职责分离，显式转换）
3. ✅ 使用 record 实现 VO（简洁、安全、高效）
4. ✅ @JsonProperty 统一 API 字段命名
5. ✅ 持久化实体与领域模型分离
