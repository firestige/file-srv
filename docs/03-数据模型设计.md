# 数据模型设计

## 模型分层（DDD 视角）

项目采用 DDD 分层，数据模型分布在不同层级：

```
file-srv-core/
├── application/entrypoint/model/    # 应用层 DTO（API 请求/响应）
│   ├── FileInfo.java
│   ├── TaskInfo.java
│   ├── MetaQueryParams.java
│   └── PartUploadInfo.java
│
├── domain/                          # 领域层实体（核心业务对象）
│   ├── files/
│   │   ├── FileAggregate.java       # 文件聚合根
│   │   └── FileInfo.java            # 领域实体
│   └── tasks/
│       ├── TaskAggregate.java       # 任务聚合根
│       ├── TaskInfo.java            # 领域实体
│       └── TaskStatus.java          # 枚举

file-srv-common/
└── context/
    ├── TaskContext.java             # 共享上下文（插件使用）
    └── Result.java                  # 统一响应包装

file-srv-adapters/
└── adapter/model/                   # 适配器层 DTO
    ├── FileMetadata.java            # 存储元数据
    └── PartETag.java                # 分片标签
```

## 应用层 DTO (application/entrypoint/model/)

### FileInfo
文件元数据，用于 API 请求/响应：

```java
public class FileInfo {
    private String fkey;           // 文件唯一标识
    private String fileName;       // 文件名
    private Long fileSize;         // 文件大小（字节）
    private String contentType;    // MIME 类型
    private String creator;        // 创建者
    private Set<String> tags;      // 标签集合
    private String url;            // 访问 URL
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
}
```

### TaskInfo
上传任务信息：

```java
public class TaskInfo {
    private String taskId;         // 任务 ID
    private String uploadId;       // 存储侧 multipart ID
    private TaskStatus status;     // 任务状态
    private String fileFkey;       // 关联文件 fkey（完成后）
    private LocalDateTime expiresAt;
    private List<String> callbacks; // 回调插件列表
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
}
```

### MetaQueryParams
元数据查询参数：

```java
@Data
public class MetaQueryParams {
    private String fileName;       // 文件名（模糊匹配）
    private String creator;        // 创建者
    private String contentType;    // 内容类型
    private LocalDateTime createdFrom;
    private LocalDateTime updatedTo;
    private Set<String> tags;      // 标签（包含任一）
}
```

### PartUploadInfo
分片上传信息：

```java
public class PartUploadInfo {
    private int partNumber;        // 分片序号
    private String eTag;           // 分片 ETag
}
```

## 领域层实体 (domain/)

### TaskStatus 枚举

```java
public enum TaskStatus {
    PENDING,        // 待处理
    IN_PROGRESS,    // 进行中
    COMPLETED,      // 已完成
    FAILED,         // 失败
    ABORTED         // 已中止
}
```

### FileAggregate / TaskAggregate
聚合根，封装领域逻辑（待实现）。

## 适配器层 DTO (adapter/model/)

### FileMetadata
存储适配器使用的文件元数据：

```java
public class FileMetadata {
    private String filename;
    private Long size;
    private String contentType;
    private String creator;
    private List<String> tags;
    private String bucket;
    private String objectKey;      // 对象键（= fkey）
}
```

### PartETag
分片标签：

```java
public class PartETag {
    private int partNumber;
    private String eTag;
}
```

## 共享上下文 (common/context/)

### TaskContext
插件执行时的共享上下文：

```java
public class TaskContext {
    private String taskId;
    private String fkey;
    private FileInfo fileInfo;
    private Map<String, Object> attributes;  // 扩展属性
}
```

### Result
统一响应包装：

```java
public record Result<E>(int code, String message, E data) {
    public static Result<Void> success();
    public static <E> Result<E> success(E data);
    public static Result<Void> failure(int code, String message);
    public static Result<Void> failure(FileServiceException e);
}
```

## 持久化实体（待实现）

### FileEntity

```java
@Entity
@Table(name = "file_meta")
public class FileEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(unique = true, nullable = false)
    private String fkey;
    
    private String filename;
    private Long size;
    private String contentType;
    private String creator;
    
    @Column(columnDefinition = "TEXT")
    private String tags;           // JSON 或逗号分隔
    
    private String url;
    private String storageType;    // hcs-obs/oss/s3...
    private String bucket;
    
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
}
```

### UploadTaskEntity

```java
@Entity
@Table(name = "upload_task")
public class UploadTaskEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(unique = true, nullable = false)
    private String taskId;
    
    private String uploadId;       // 存储侧 ID
    private String fileFkey;       // 完成后关联
    private String bucket;
    
    @Enumerated(EnumType.STRING)
    private TaskStatus status;
    
    private LocalDateTime expiresAt;
    
    @Column(columnDefinition = "TEXT")
    private String callbackNames;  // JSON
    
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
}
```

### UploadPartEntity（可选）

```java
@Entity
@Table(name = "upload_part")
public class UploadPartEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    private String taskId;
    private Integer partNumber;
    private String eTag;
    private Long size;
    private LocalDateTime uploadedAt;
}
```

## 索引建议

| 表 | 索引 | 用途 |
|---|------|------|
| file_meta | `uk_fkey` (unique) | fkey 查询 |
| file_meta | `idx_creator_createdAt` | 创建者+时间查询 |
| file_meta | `idx_contentType_createdAt` | 类型+时间查询 |
| upload_task | `uk_taskId` (unique) | taskId 查询 |
| upload_task | `idx_status_updatedAt` | 状态查询 |
| upload_part | `uk_taskId_partNumber` (unique) | 分片查询 |

## Redis 缓存键设计

| 键 | 值 | TTL | 用途 |
|---|-----|-----|------|
| `file:meta:{fkey}` | FileInfo JSON | 30min | 文件元数据缓存 |
| `file:query:{hash}` | Page JSON | 5min | 查询结果缓存 |
| `upload:task:{taskId}` | TaskInfo JSON | 24h | 任务状态缓存 |
| `upload:task:{taskId}:parts` | List JSON | 24h | 分片列表缓存 |

## 数据一致性

1. **写路径**：DB 成功 → 失效缓存
2. **读路径**：Caffeine → Redis → DB → 回填缓存
3. **删除路径**：删存储 → 删 DB → 删缓存
