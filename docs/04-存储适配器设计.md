# 存储适配器设计

## 目标

- 屏蔽对象存储/NAS 差异，为业务层提供统一接口
- 通过 Spring Boot 自动装配加载单一激活的适配器实现
- 支持同步上传、分片上传、下载、预签名等核心操作
- **分片上传通过 UploadSession 封装**，简化调用方使用

## 模块结构

```
file-srv-adapters/
├── pom.xml                          # 父 POM，依赖 core
└── file-srv-adapter-hcs/            # 华为云 OBS 适配器
    ├── pom.xml
    └── src/main/java/tech/icc/filesrv/adapter/
        ├── hcs/
        │   ├── HcsStorageAdapter.java     # 适配器实现
        │   ├── HcsUploadSession.java      # 分片上传会话实现
        │   └── config/
        │       ├── HcsObsAutoConfiguration.java
        │       └── ObsProperties.java
        └── model/
            └── FileMetadata.java    # 文件元数据 DTO
```

## 接口定义

### StorageAdapter 接口 (修订版)

位置：`file-srv-core/src/main/java/tech/icc/filesrv/core/infra/storage/StorageAdapter.java`

```java
public interface StorageAdapter {
    
    // ==================== 简单文件操作 ====================
    
    /**
     * 上传文件（适用于小文件）
     * @param path 存储路径
     * @param data 文件数据流
     * @param size 文件大小
     * @param contentType MIME 类型
     */
    void put(String path, InputStream data, long size, String contentType);
    
    /**
     * 下载文件，返回输入流（调用方负责关闭）
     * @param path 存储路径
     * @return 文件输入流
     */
    InputStream get(String path);
    
    /**
     * 删除文件（幂等，不存在时不抛异常）
     * @param path 存储路径
     */
    void delete(String path);
    
    /**
     * 检查文件是否存在
     * @param path 存储路径
     * @return 是否存在
     */
    boolean exists(String path);
    
    // ==================== 预签名 ====================
    
    /**
     * 生成预签名下载 URL
     * @param path 存储路径
     * @param expiry 有效期
     * @return 预签名 URL
     */
    URI presignDownload(String path, Duration expiry);
    
    // ==================== 分片上传 ====================
    
    /**
     * 开始分片上传会话
     * @param path 存储路径
     * @param contentType MIME 类型
     * @return 上传会话
     */
    UploadSession beginUpload(String path, String contentType);
}
```

### UploadSession 接口 (新增)

位置：`file-srv-core/src/main/java/tech/icc/filesrv/core/infra/storage/UploadSession.java`

```java
/**
 * 分片上传会话，封装 S3/OBS 等存储的分片上传细节
 * 
 * <p>设计目的：
 * <ul>
 *   <li>屏蔽不同存储的分片 API 差异</li>
 *   <li>简化调用方使用：不需要关心 uploadId、objectKey 等内部概念</li>
 *   <li>支持会话持久化与恢复</li>
 * </ul>
 */
public interface UploadSession extends AutoCloseable {
    
    /**
     * 获取会话 ID（用于持久化和恢复）
     * 对于 S3/OBS 实现，这通常是 uploadId
     */
    String getSessionId();
    
    /**
     * 上传单个分片
     * @param partNumber 分片序号（1-based）
     * @param data 分片数据流
     * @param size 分片大小
     * @return 该分片的 ETag
     */
    String uploadPart(int partNumber, InputStream data, long size);
    
    /**
     * 完成上传，合并所有分片
     * @param parts 所有分片信息（partNumber + etag）
     * @return 最终文件的存储路径
     */
    String complete(List<PartInfo> parts);
    
    /**
     * 中止上传，清理已上传的分片
     */
    void abort();
    
    /**
     * 资源释放
     */
    @Override
    void close();
}
```

### PartInfo 值对象

位置：`file-srv-core/src/main/java/tech/icc/filesrv/core/domain/tasks/PartInfo.java`

```java
/**
 * 分片信息值对象
 */
public record PartInfo(
    int partNumber,     // 分片序号 (1-based)
    String etag,        // 存储层返回的 ETag
    long size           // 分片大小
) {}
```

## 接口演进说明

| 原接口 | 新接口 | 说明 |
|--------|--------|------|
| `uploadFile(in, meta)` | `put(path, data, size, contentType)` | 简化参数，path 由调用方决定 |
| `downloadFile(fkey)` | `get(path)` | 统一命名 |
| `generatePresignedUrl(fkey, exp)` | `presignDownload(path, expiry)` | 明确是下载签名 |
| `deleteFile(fkey)` | `delete(path)` | 统一命名 |
| `exists(fkey)` | `exists(path)` | 保持不变 |
| `initiateMultipartUpload` | `beginUpload() → session` | 封装到 Session |
| `uploadPart` | `session.uploadPart()` | 封装到 Session |
| `completeMultipartUpload` | `session.complete()` | 封装到 Session |
| `abortMultipartUpload` | `session.abort()` | 封装到 Session |

## 辅助 DTO

#### FileMetadata（保留用于内部）
```java
@Data
public class FileMetadata {
    private String filename;
    private Long size;
    private String contentType;
    private String creator;
    private List<String> tags;
    private String bucket;
    private String objectKey;  // 对象键，= path
}
```

## 华为云 OBS 适配器实现

### HcsStorageAdapter

已实现功能：

| 方法 | 状态 | 说明 |
|-----|------|------|
| `put` | ✅ | 使用 `PutObjectRequest` 上传 |
| `get` | ✅ | 使用 `getObject` 获取流 |
| `presignDownload` | ✅ | 使用 `createTemporarySignature` |
| `delete` | ✅ | 使用 `deleteObject` |
| `exists` | ✅ | 使用 `doesObjectExist` |
| `beginUpload` | ✅ | 返回 `HcsUploadSession` |

### HcsUploadSession

```java
public class HcsUploadSession implements UploadSession {
    
    private final ObsClient obsClient;
    private final String bucket;
    private final String objectKey;
    private final String uploadId;
    
    // 构造时调用 initiateMultipartUpload
    public HcsUploadSession(ObsClient client, String bucket, String key, String contentType) {
        this.obsClient = client;
        this.bucket = bucket;
        this.objectKey = key;
        this.uploadId = initUpload(contentType);
    }
    
    @Override
    public String getSessionId() {
        return uploadId;
    }
    
    @Override
    public String uploadPart(int partNumber, InputStream data, long size) {
        UploadPartResult result = obsClient.uploadPart(
            new UploadPartRequest(bucket, objectKey, uploadId, partNumber, data, size)
        );
        return normalizeETag(result.getEtag());
    }
    
    @Override
    public String complete(List<PartInfo> parts) {
        List<PartEtag> obsParts = parts.stream()
            .sorted(Comparator.comparingInt(PartInfo::partNumber))
            .map(p -> new PartEtag(p.etag(), p.partNumber()))
            .toList();
        obsClient.completeMultipartUpload(
            new CompleteMultipartUploadRequest(bucket, objectKey, uploadId, obsParts)
        );
        return objectKey;
    }
    
    @Override
    public void abort() {
        obsClient.abortMultipartUpload(
            new AbortMultipartUploadRequest(bucket, objectKey, uploadId)
        );
    }
    
    @Override
    public void close() {
        // 资源清理（如有需要）
    }
}
```

### 自动装配配置

```java
@AutoConfiguration
@EnableConfigurationProperties(ObsProperties.class)
@ConditionalOnClass(ObsClient.class)
public class HcsObsAutoConfiguration {

    @Bean
    @ConditionalOnMissingBean
    @ConditionalOnProperty(name = "storage.obs.enabled", havingValue = "true")
    public ObsClient obsClient(ObsProperties properties) {
        // 校验配置并创建 ObsClient
    }

    @Bean
    @ConditionalOnMissingBean(StorageAdapter.class)
    @ConditionalOnProperty(name = "storage.obs.enabled", havingValue = "true")
    public StorageAdapter hcsObsAdapter(ObsClient obsClient, ObsProperties properties) {
        return new HcsObsAdapter(obsClient, properties);
    }
}
```

### 配置属性

```yaml
storage:
  obs:
    enabled: true
    endpoint: https://obs.cn-north-4.myhuaweicloud.com
    bucket-name: ${OBS_BUCKET}
    access-key: ${OBS_ACCESS_KEY}
    secret-key: ${OBS_SECRET_KEY}
    presigned-url-expiration: 3600s  # 预签名 URL 默认有效期
```

## 异常处理

- 捕获 SDK 异常，转换为 `FileServiceException`
- 错误码定义在 `ResultCode`

| 场景 | 处理方式 |
|-----|---------|
| 鉴权失败 | 抛出异常 |
| 桶/对象不存在 | `NOT_FOUND` 错误码 |
| 网络超时 | 抛出异常，上层重试 |
| 分片合并失败 | 抛出异常 |
| abort 时对象不存在 | 幂等返回（不抛异常） |

## ETag 标准化

OBS SDK 返回的 ETag 带引号，需要标准化：

```java
private String normalizeETag(String etag) {
    if (etag != null && etag.startsWith("\"") && etag.endsWith("\"")) {
        return etag.substring(1, etag.length() - 1);
    }
    return etag;
}
```

## 其他存储（未来扩展）

| 存储类型 | 适配策略 |
|---------|---------|
| OSS/COS/S3 | 接口一致，主要差异在 SDK 与签名方式 |
| MinIO/Ceph | S3 兼容协议，可复用 S3 适配器 |
| NAS | 自定义实现（本地/网络文件系统读写） |

## 监控指标（建议）

- 上传/下载耗时、吞吐、失败率
- 分片重试次数、合并失败次数
- 预签名 URL 请求量

## 测试建议

- **单元测试**：Mock ObsClient 验证适配器逻辑
- **集成测试**：使用 Testcontainer + MinIO 模拟 S3 兼容存储
- **压力测试**：验证 10k 分片、大文件、并发上传
