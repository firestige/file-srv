# 存储适配器设计

## 目标

- 屏蔽对象存储/NAS 差异，为业务层提供统一接口
- 通过 Spring Boot 自动装配加载单一激活的适配器实现
- 支持同步上传、分片上传、下载、预签名等核心操作

## 模块结构

```
file-srv-adapters/
├── pom.xml                          # 父 POM，依赖 core
└── file-srv-adapter-hcs/            # 华为云 OBS 适配器
    ├── pom.xml
    └── src/main/java/tech/icc/filesrv/adapter/
        ├── hcs/
        │   ├── HcsObsAdapter.java   # 适配器实现
        │   └── config/
        │       ├── HcsObsAutoConfiguration.java
        │       └── ObsProperties.java
        └── model/
            ├── FileMetadata.java    # 文件元数据 DTO
            └── PartETag.java        # 分片标签 DTO
```

## 接口定义

### StorageAdapter 接口

位置：`file-srv-core/src/main/java/tech/icc/filesrv/core/infra/storage/StorageAdapter.java`

```java
public interface StorageAdapter {
    // ==================== 同步上传 ====================
    
    /**
     * 同步上传小文件（≤10MB）
     * @param in 文件输入流
     * @param meta 文件元数据
     * @return 对象键 fkey
     */
    String uploadFile(InputStream in, FileMetadata meta);

    // ==================== 下载 ====================
    
    /**
     * 直连下载，返回输入流（调用方负责关闭）
     * @param fkey 文件唯一标识
     * @return 文件输入流
     */
    InputStream downloadFile(String fkey);
    
    /**
     * 生成预签名 URL
     * @param fkey 文件唯一标识
     * @param expiration 有效期，null 表示使用默认配置
     * @return 预签名 URL
     */
    String generatePresignedUrl(String fkey, Duration expiration);

    // ==================== 删除 ====================
    
    /**
     * 删除对象，不存在时应幂等返回
     * @param fkey 文件唯一标识
     */
    void deleteFile(String fkey);

    // ==================== 检查 ====================
    
    /**
     * 存在性检查
     * @param fkey 文件唯一标识
     * @return 是否存在
     */
    boolean exists(String fkey);

    // ==================== 分片上传 ====================
    
    /**
     * 初始化分片上传
     * @param meta 文件元数据
     * @return uploadId
     */
    String initiateMultipartUpload(FileMetadata meta);
    
    /**
     * 上传分片
     * @param objectKey 对象键
     * @param uploadId 上传 ID
     * @param partNumber 分片序号（1-based）
     * @param in 分片输入流
     * @param partSize 分片大小
     * @return 分片 ETag
     */
    String uploadPart(String objectKey, String uploadId, int partNumber, 
                      InputStream in, long partSize);
    
    /**
     * 完成分片上传
     * @param objectKey 对象键
     * @param uploadId 上传 ID
     * @param parts 分片列表（需按 partNumber 排序）
     */
    void completeMultipartUpload(String objectKey, String uploadId, List<PartETag> parts);
    
    /**
     * 中止分片上传
     * @param objectKey 对象键
     * @param uploadId 上传 ID
     */
    void abortMultipartUpload(String objectKey, String uploadId);
}
```

### 辅助 DTO

#### FileMetadata
```java
@Data
public class FileMetadata {
    private String filename;
    private Long size;
    private String contentType;
    private String creator;
    private List<String> tags;
    private String bucket;
    private String objectKey;  // 对象键，= fkey
}
```

#### PartETag
```java
@Data
public class PartETag {
    private int partNumber;
    private String eTag;
}
```

## 华为云 OBS 适配器实现

### HcsObsAdapter

已实现功能：

| 方法 | 状态 | 说明 |
|-----|------|------|
| `uploadFile` | ✅ | 使用 `PutObjectRequest` 上传 |
| `downloadFile` | ✅ | 使用 `getObject` 获取流 |
| `generatePresignedUrl` | ✅ | 使用 `createTemporarySignature` |
| `deleteFile` | ✅ | 使用 `deleteObject` |
| `exists` | ✅ | 使用 `doesObjectExist` |
| `initiateMultipartUpload` | ✅ | 使用 `initiateMultipartUpload` |
| `uploadPart` | ✅ | 使用 `uploadPart` |
| `completeMultipartUpload` | ✅ | 使用 `completeMultipartUpload` |
| `abortMultipartUpload` | ✅ | 使用 `abortMultipartUpload`，幂等处理 |

### 自动装配配置

```java
@AutoConfiguration
@EnableConfigurationProperties(ObsProperties.class)
@ConditionalOnClass(ObsClient.class)
public class HcsObsAutoConfiguration {

    @Bean
    @ConditionalOnMissingBean
    @ConditionalOnProperty(name = "storage.obs.enabled", havingValue = "true")
    public ObsClient obsClient(ObsProperties properties) {
        // 校验配置并创建 ObsClient
    }

    @Bean
    @ConditionalOnMissingBean(StorageAdapter.class)
    @ConditionalOnProperty(name = "storage.obs.enabled", havingValue = "true")
    public StorageAdapter hcsObsAdapter(ObsClient obsClient, ObsProperties properties) {
        return new HcsObsAdapter(obsClient, properties);
    }
}
```

### 配置属性

```yaml
storage:
  obs:
    enabled: true
    endpoint: https://obs.cn-north-4.myhuaweicloud.com
    bucket-name: ${OBS_BUCKET}
    access-key: ${OBS_ACCESS_KEY}
    secret-key: ${OBS_SECRET_KEY}
    presigned-url-expiration: 3600s  # 预签名 URL 默认有效期
```

## 异常处理

- 捕获 SDK 异常，转换为 `FileServiceException`
- 错误码定义在 `ResultCode`

| 场景 | 处理方式 |
|-----|---------|
| 鉴权失败 | 抛出异常 |
| 桶/对象不存在 | `NOT_FOUND` 错误码 |
| 网络超时 | 抛出异常，上层重试 |
| 分片合并失败 | 抛出异常 |
| abort 时对象不存在 | 幂等返回（不抛异常） |

## ETag 标准化

OBS SDK 返回的 ETag 带引号，需要标准化：

```java
private String normalizeETag(String etag) {
    if (etag != null && etag.startsWith("\"") && etag.endsWith("\"")) {
        return etag.substring(1, etag.length() - 1);
    }
    return etag;
}
```

## 其他存储（未来扩展）

| 存储类型 | 适配策略 |
|---------|---------|
| OSS/COS/S3 | 接口一致，主要差异在 SDK 与签名方式 |
| MinIO/Ceph | S3 兼容协议，可复用 S3 适配器 |
| NAS | 自定义实现（本地/网络文件系统读写） |

## 监控指标（建议）

- 上传/下载耗时、吞吐、失败率
- 分片重试次数、合并失败次数
- 预签名 URL 请求量

## 测试建议

- **单元测试**：Mock ObsClient 验证适配器逻辑
- **集成测试**：使用 Testcontainer + MinIO 模拟 S3 兼容存储
- **压力测试**：验证 10k 分片、大文件、并发上传
