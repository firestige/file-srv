# ICC File Service - 项目概述

## 项目简介

ICC File Service 是一个基于 **领域驱动设计（DDD）** 的**云存储中间件服务**，旨在为上层应用提供统一的文件存储接口，屏蔽底层不同对象存储实现的差异。通过适配器模式和 Spring Boot 自动装配机制，支持灵活切换和扩展多种存储后端。

## 项目定位

- **中间件服务**：位于应用层和存储层之间，提供存储抽象
- **DDD 架构**：采用领域驱动设计，清晰分离领域逻辑、应用服务与基础设施
- **多存储支持**：支持公有云对象存储（华为云 OBS、阿里云 OSS、腾讯云 COS、AWS S3）、私有化部署存储（MinIO、Ceph）、网络存储（NAS）
- **统一接口**：上层应用无需关心底层存储差异，通过统一的 REST API 操作文件
- **无状态设计**：支持水平扩容，所有状态信息存储在数据库和 Redis 中

## 技术栈

| 技术类别     | 技术选型          | 版本   | 用途                     |
| ------------ | ----------------- | ------ | ------------------------ |
| 框架         | Spring Boot       | 3.2.12 | 应用框架                 |
| 语言         | Java              | 17     | 开发语言                 |
| 构建工具     | Maven             | -      | 项目管理和构建           |
| Web          | Spring Web        | -      | REST API                 |
| 数据访问     | Spring Data JPA   | -      | 文件元数据持久化         |
| 缓存         | Spring Data Redis | -      | 元数据查询加速、状态缓存 |
| 本地缓存     | Caffeine          | -      | 多级缓存（规划中）       |
| 工具库       | Lombok            | -      | 减少样板代码             |
| 监控         | Spring Actuator   | -      | 健康检查和监控指标       |
| AOP          | Spring AOP        | -      | 切面编程（可见性、审计） |
| 对象存储 SDK | 华为云 OBS SDK    | 3.23.9 | 华为云存储适配           |

## 模块结构（DDD 分层）

项目采用基于 DDD 的多模块架构：

```
icc-file-srv/
├── file-srv-core/                   # 核心模块（领域层 + 应用层 + 基础设施实现）
│   └── tech.icc.filesrv.core/
│       ├── domain/                  # 领域层
│       │   ├── files/               # 文件聚合（FileAggregate、FileInfo）
│       │   └── tasks/               # 任务聚合（TaskAggregate、TaskInfo、TaskStatus）
│       ├── application/             # 应用层
│       │   ├── entrypoint/          # 入口点（Controller、DTO）
│       │   │   └── model/           # 请求/响应模型（FileInfo、TaskInfo、MetaQueryParams...）
│       │   └── service/             # 应用服务（FileService、TaskService）
│       └── infra/                   # 基础设施实现
│           ├── storage/             # 存储注册中心（StorageAdapterRegistry）
│           └── plugin/              # 插件注册中心（PluginRegistry）
│
├── file-srv-common/                 # 公共模块（无依赖的工具和共享上下文）
│   └── tech.icc.filesrv.common/
│       ├── constants/               # 常量（SystemConstant、ResultCode、CacheConstants）
│       ├── context/                 # 共享上下文（TaskContext、Result）
│       ├── exception/               # 异常体系（FileServiceException、FileNotFoundException）
│       └── spi/                     # SPI 契约（扩展点接口）
│           ├── storage/             # 存储适配器契约（StorageAdapter、UploadSession）
│           └── plugin/              # 插件契约（SharedPlugin、PluginResult）
│
├── file-srv-adapters/               # 存储适配器集合
│   └── file-srv-adapter-hcs/        # 华为云 OBS 适配器
│       └── tech.icc.filesrv.adapter.hcs/
│           ├── HcsObsAdapter        # 适配器实现
│           └── config/              # 自动配置（HcsObsAutoConfiguration、ObsProperties）
│
├── file-srv-aspect/                 # 切面模块（可见性、审计等横切关注点）
│
├── file-srv-autoconfiguration/      # Spring 自动装配配置
│   └── tech.icc.filesrv.config/
│       └── FileServiceAutoConfiguration
│
├── file-srv-plugins/                # 后处理插件集合
│   └── file-srv-plugin-example/     # 示例插件（RenamePlugin）
│
├── file-srv-test/                   # 集成测试、基准性能测试
│   └── tech.icc.filesrv/
│       └── Bootstrap                # 测试启动类
│
└── docs/                            # 项目文档
```

## 模块职责说明

| 模块                           | 职责                                                           | 依赖关系                     |
| ------------------------------ | -------------------------------------------------------------- | ---------------------------- |
| **file-srv-core**              | 核心业务逻辑，包含领域模型、应用服务、Controller、基础设施实现 | 依赖 common                  |
| **file-srv-common**            | 无依赖的公共工具、常量、异常、共享上下文、SPI 契约             | 无依赖                       |
| **file-srv-adapters**          | 存储适配器实现集合，每种存储一个子模块                         | 依赖 common（实现 SPI 契约） |
| **file-srv-aspect**            | 切面管理（可见性控制、审计日志等横切关注点）                   | 依赖 core                    |
| **file-srv-autoconfiguration** | Spring Boot 自动装配配置                                       | 依赖 core                    |
| **file-srv-plugins**           | 后处理插件集合，上传完成后按顺序调用                           | 依赖 common（实现 SPI 契约） |
| **file-srv-test**              | 集成测试、基准性能测试                                         | 依赖 autoconfiguration       |

## 核心特性

### 1. 文件上传

- **同步上传**：适用于 ≤10MB 的小文件，单次 HTTP 请求完成
- **分片上传**：适用于 ≥5MB 的大文件，支持断点续传
  - 分片数量上限：10,000 片
  - 单分片大小：5MB ~ 1GB（最后一片除外）
  - 支持并发上传多个分片

### 2. 文件下载

- **直接下载**：服务端代理，适用于小文件或需要鉴权的场景
- **预签名 URL**：生成对象存储临时访问链接，客户端直接下载
  - 支持永久/限时 URL
  - 适用于高频下载、大文件、阅后即焚等场景

### 3. 文件管理

- **删除文件**：同时删除对象存储文件和元数据
- **元数据查询**：支持多维度检索
  - 文件名（模糊匹配）
  - 创建者
  - 标签
  - 创建时间范围
  - 文件类型
- **存在性检查**：快速判断文件是否存在

### 4. 上传任务管理

- **任务生命周期管理**：创建、进行中、完成、失败、中止
- **任务详情查询**：实时获取上传进度和状态
- **任务持久化**：支持断点恢复

### 5. 回调插件机制

- **后处理扩展**：文件上传完成后执行自定义逻辑
- **典型场景**：
  - 音视频转码（格式转换、码率调整）
  - 元数据提取（时长、分辨率、采样率）
  - 缩略图生成
  - 内容审核

### 6. 文件唯一标识 (fkey)

- **用户指定**：客户端提供业务相关的唯一标识
- **对象存储生成**：使用对象存储的对象键（如 OBS 对象名）
- **分布式 ID**：非对象存储场景使用 Snowflake 等算法

## 分层架构（DDD 视角）

```
┌──────────────────────────────────────────────────────────────────┐
│                    应用层 (Application Layer)                     │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │              入口点 (Entrypoint / Controller)               │  │
│  │   FileController | TaskController | StaticResourceController│  │
│  └────────────────────────────────────────────────────────────┘  │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │                   应用服务 (Application Service)            │  │
│  │                  FileService | TaskService                  │  │
│  └────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────────┘
                                  │
┌──────────────────────────────────────────────────────────────────┐
│                      领域层 (Domain Layer)                        │
│  ┌─────────────────────────┐  ┌─────────────────────────────┐   │
│  │     文件聚合 (Files)      │  │      任务聚合 (Tasks)        │   │
│  │  FileAggregate          │  │  TaskAggregate              │   │
│  │  FileInfo               │  │  TaskInfo / TaskStatus      │   │
│  └─────────────────────────┘  └─────────────────────────────┘   │
└──────────────────────────────────────────────────────────────────┘
                                  │
┌──────────────────────────────────────────────────────────────────┐
│                  基础设施层 (Infrastructure Layer)                │
│  ┌─────────────────┐  ┌───────────────┐  ┌──────────────────┐   │
│  │  StorageAdapter │  │  SharedPlugin │  │   Repository     │   │
│  │     (接口)       │  │    (接口)     │  │     (JPA)        │   │
│  └────────┬────────┘  └───────┬───────┘  └──────────────────┘   │
│           │                   │                                  │
│  ┌────────▼────────┐  ┌───────▼───────┐                         │
│  │  HcsObsAdapter  │  │ RenamePlugin  │    ...更多实现           │
│  │  (华为云OBS)     │  │   (示例)      │                         │
│  └─────────────────┘  └───────────────┘                         │
└──────────────────────────────────────────────────────────────────┘
```

## 设计原则

1. **领域驱动设计**：核心业务逻辑集中在领域层，与技术实现解耦
2. **存储无关**：上层业务不感知底层存储实现
3. **适配器模式**：通过 StorageAdapter 接口隔离存储差异
4. **插件化扩展**：通过 SharedPlugin 接口支持后处理扩展
5. **无状态服务**：所有状态存储在数据库/Redis，支持水平扩容
6. **多级缓存**：Redis + Caffeine，减少数据库和对象存储访问
7. **异常统一**：所有异常转换为 FileServiceException，统一处理
8. **配置驱动**：通过配置文件和 Spring 自动装配动态加载适配器

## 开发状态

| 模块                | 状态      | 说明                                                     |
| ------------------- | --------- | -------------------------------------------------------- |
| 项目脚手架          | ✅ 完成   | DDD 多模块结构搭建完成                                   |
| REST API 定义       | ✅ 完成   | FileController、TaskController、StaticResourceController |
| StorageAdapter 接口 | ✅ 完成   | 定义完整的存储适配器方法签名                             |
| HcsObsAdapter       | ✅ 完成   | 华为云 OBS 适配器完整实现（含分片上传）                  |
| 领域模型            | ⏳ 进行中 | FileAggregate、TaskAggregate 框架已建立                  |
| 应用服务            | ⏳ 进行中 | FileService、TaskService 接口骨架                        |
| 异常体系            | ✅ 完成   | FileServiceException、FileNotFoundException              |
| 共享上下文          | ✅ 完成   | TaskContext、Result 响应包装                             |
| 插件框架            | ✅ 完成   | SharedPlugin 接口 + 示例插件                             |
| Repository 层       | ⏳ 待开始 | JPA 实体类和接口待实现                                   |
| Redis 配置          | ⏳ 待开始 | 缓存策略待设计                                           |
| 切面模块            | ⏳ 待开始 | 可见性、审计等切面待实现                                 |
| 集成测试            | ⏳ 待开始 | Testcontainer + MinIO 测试                               |

## 相关文档

- [01-架构设计](./01-架构设计.md) - DDD 分层架构详细设计
- [02-API 设计](./02-API设计.md) - REST API 接口规范
- [03-数据模型设计](./03-数据模型设计.md) - 领域模型与 DTO 定义
- [04-存储适配器设计](./04-存储适配器设计.md) - StorageAdapter 接口和实现规范
- [05-开发计划](./05-开发计划.md) - 迭代开发任务规划
- [features/](./features/) - 各迭代详细设计文档
