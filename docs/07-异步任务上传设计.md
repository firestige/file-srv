# 异步任务上传设计

> **最后更新**: 2026-01-31  
> **版本**: v1.2  
> **变更**: 架构优化 - 移除降级逻辑，强化防腐层职责

## 零、架构演进记录

### v1.2 (2026-01-31) - 防腐层职责强化

**背景问题**：
- TaskService中存在针对StorageAdapter的降级逻辑（try-catch处理UnsupportedOperationException）
- 每次uploadPart/completeUpload时如果resumeUpload失败就重新beginUpload
- 违反了DDD分层原则：应用层不应了解基础设施层的实现细节

**架构调整**：
1. **移除降级逻辑**：TaskService直接调用resumeUpload()，不处理异常
2. **强化SPI契约**：StorageAdapter必须实现resumeUpload()，不支持则抛异常
3. **防腐层负责**：Adapter实现类处理存储层差异（如S3 vs HCS vs本地文件）
4. **ETag标准化**：Adapter负责标准化ETag格式（移除引号等）

**模块职责**：
```
TaskService (应用层)
  ↓ 调用
StorageAdapter (SPI接口)
  ↓ 实现
HcsStorageAdapter / S3StorageAdapter (防腐层)
  ↓ 适配
HCS SDK / AWS SDK (第三方库)
```

**代码影响**：
- TaskService.uploadPart()：移除try-catch，直接调用resumeUpload()
- TaskService.completeUpload()：移除降级逻辑
- TaskService.abortUpload()：简化异常处理
- ObjectStorageServiceStub：实现resumeUpload()，修复close()行为

### v1.1 (2026-01-25) - TaskStatus模块调整

**架构调整**：
- 将TaskStatus从`core.domain.tasks`移至`common.vo.task`
- 原因：TaskStatus是跨层共享的值对象，避免circular dependency
- TaskSummary需要引用TaskStatus，而TaskSummary在common模块

**模块依赖**：
```
common (共享VO)
  ↑
core (领域层/应用层)
```

## 一、设计目标

支持大文件分片上传 + 后处理 (Callback) 的完整流程：

| 能力     | 说明                                       |
| -------- | ------------------------------------------ |
| 分片上传 | 服务端中转模式，客户端 → file-srv → 存储层 |
| 后处理链 | 调用方指定 callbacks，按顺序执行 Plugin    |
| 断点恢复 | 支持从中断点继续执行                       |
| 状态追踪 | 完整的任务状态机                           |

## 二、整体流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           完整生命周期                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────┐    ┌───────────┐    ┌──────────┐    ┌──────────────────────┐ │
│  │ 创建任务  │───►│ 分片上传   │───►│ 完成上传  │───►│ 执行 Callback 链     │ │
│  │ PENDING  │    │IN_PROGRESS│    │PROCESSING│    │                      │ │
│  └──────────┘    └───────────┘    └──────────┘    │ plugin1 ► plugin2 ►..│ │
│       │               │               │           └──────────────────────┘ │
│       │               │               │                      │             │
│       ▼               ▼               ▼                      ▼             │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                         异常分支                                      │  │
│  │  ABORTED (用户中止)  │  FAILED (上传/处理失败)  │  EXPIRED (超时)      │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│                                      │                                      │
│                                      ▼                                      │
│                              ┌──────────────┐                               │
│                              │  COMPLETED   │                               │
│                              │ 绑定FileRef  │                               │
│                              └──────────────┘                               │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 三、核心概念

### 3.1 任务 vs 文件

| 概念              | 生命周期 | 说明                                          |
| ----------------- | -------- | --------------------------------------------- |
| **TaskAggregate** | 临时     | 上传任务，完成后可清理                        |
| **FileReference** | 永久     | 用户文件引用，任务完成后绑定                  |
| **FileInfo**      | 永久     | 物理文件，多任务可能指向同一 FileInfo（去重） |

### 3.2 Callback 机制

- 调用方在 `createTask` 时指定 `callbacks` 参数
- 格式：`"plugin1,plugin2,plugin3"`（逗号分隔）
- 执行顺序：按参数顺序，顺序执行
- **参数传递**：通过 `TaskContext`，使用 `{pluginName}.{paramKey}` 约定传递各 Plugin 参数

```
createTask 请求示例：
{
  "fKey": {...},
  "callbacks": "thumbnail,watermark,rename",
  "params": {
    "thumbnail.width": 200,
    "thumbnail.height": 200,
    "thumbnail.format": "webp",
    "watermark.text": "ICC © 2026",
    "watermark.position": "bottom-right",
    "rename.pattern": "{date}/{uuid}.{ext}"
  }
}
```

### 3.3 任务完成通知

任务终态时通过 **Kafka** 广播事件，供下游系统消费：

| 事件                 | Topic                 | 触发时机                 |
| -------------------- | --------------------- | ------------------------ |
| `TaskCompletedEvent` | `file-task-completed` | 所有 callback 执行成功   |
| `TaskFailedEvent`    | `file-task-failed`    | 上传失败或 callback 失败 |

### 3.4 后处理文件数据来源

Plugin 执行时需要访问文件内容，设计如下：

```
┌──────────────────────────────────────────────────────────────────────────┐
│                      文件数据访问策略                                      │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  上传完成时                                                               │
│       │                                                                  │
│       ▼                                                                  │
│  ┌─────────────────────┐     是      ┌─────────────────────┐            │
│  │ 本地有临时文件缓存？ │────────────►│ TaskContext 记录     │            │
│  └─────────────────────┘             │ localFilePath       │            │
│       │ 否                           └─────────────────────┘            │
│       ▼                                                                  │
│  ┌─────────────────────┐                                                │
│  │ 从存储层下载到本地   │     TaskContext 记录                            │
│  │ 临时目录            │────►localFilePath                              │
│  └─────────────────────┘                                                │
│                                                                          │
│  Plugin 执行时                                                           │
│       │                                                                  │
│       ▼                                                                  │
│  ┌─────────────────────┐                                                │
│  │ 从 TaskContext 获取  │                                                │
│  │ localFilePath       │                                                │
│  │ 直接读取本地文件     │                                                │
│  └─────────────────────┘                                                │
│                                                                          │
│  所有 Plugin 执行完毕                                                     │
│       │                                                                  │
│       ▼                                                                  │
│  ┌─────────────────────┐                                                │
│  │ 清理本地临时文件     │                                                │
│  └─────────────────────┘                                                │
└──────────────────────────────────────────────────────────────────────────┘
```

**关键设计**：

- `TaskContext.KEY_LOCAL_FILE_PATH`：本地临时文件路径
- `TaskContext.KEY_STORAGE_PATH`：存储层路径（供 Plugin 生成衍生文件）
- 临时文件在 **所有 callback 完成后** 统一清理，避免重复下载

## 四、时序图

### 4.1 创建任务

```
 Client                   TaskController           TaskService            TaskAggregate          TaskRepository
   │                           │                       │                       │                      │
   │  POST /tasks              │                       │                       │                      │
   │  {fKey, hash, callbacks}  │                       │                       │                      │
   │──────────────────────────►│                       │                       │                      │
   │                           │                       │                       │                      │
   │                           │  createTask(cmd)      │                       │                      │
   │                           │──────────────────────►│                       │                      │
   │                           │                       │                       │                      │
   │                           │                       │  new TaskAggregate()  │                      │
   │                           │                       │──────────────────────►│                      │
   │                           │                       │                       │                      │
   │                           │                       │       aggregate       │                      │
   │                           │                       │◄──────────────────────│                      │
   │                           │                       │                       │                      │
   │                           │                       │                 save(aggregate)              │
   │                           │                       │─────────────────────────────────────────────►│
   │                           │                       │                       │                      │
   │                           │    TaskInfoDto        │                       │                      │
   │                           │◄──────────────────────│                       │                      │
   │                           │                       │                       │                      │
   │    201 {taskId, status}   │                       │                       │                      │
   │◄──────────────────────────│                       │                       │                      │
```

### 4.2 上传分片

```
 Client                   TaskController           TaskService             StorageAdapter          UploadSession
   │                           │                       │                       │                      │
   │  PUT /tasks/{id}/parts    │                       │                       │                      │
   │  {partNumber, data}       │                       │                       │                      │
   │──────────────────────────►│                       │                       │                      │
   │                           │                       │                       │                      │
   │                           │  uploadPart(cmd)      │                       │                      │
   │                           │──────────────────────►│                       │                       │
   │                           │                       │                       │                      │
   │                           │                       │  [首次] beginUpload() │                      │
   │                           │                       │──────────────────────►│                      │
   │                           │                       │                       │                      │
   │                           │                       │     UploadSession     │                      │
   │                           │                       │◄──────────────────────│                      │
   │                           │                       │                       │                      │
   │                           │                       │           uploadPart(partNo, data)          │
   │                           │                       │─────────────────────────────────────────────►│
   │                           │                       │                       │                      │
   │                           │                       │              PartETag                        │
   │                           │                       │◄─────────────────────────────────────────────│
   │                           │                       │                       │                      │
   │                           │                       │  记录 part 到 aggregate                      │
   │                           │                       │                       │                      │
   │                           │   PartETagDto         │                       │                      │
   │                           │◄──────────────────────│                       │                      │
   │                           │                       │                       │                      │
   │    200 {partNo, etag}     │                       │                       │                      │
   │◄──────────────────────────│                       │                       │                      │
```

### 4.3 完成上传 + Callback 执行 + 事件通知

```
 Client              TaskController         TaskService          UploadSession       PluginRegistry        Plugin          KafkaTemplate
   │                      │                      │                     │                   │                  │                  │
   │ POST /tasks/{id}/    │                      │                     │                   │                  │                  │
   │      complete        │                      │                     │                   │                  │                  │
   │─────────────────────►│                      │                     │                   │                  │                  │
   │                      │                      │                     │                   │                  │                  │
   │                      │ completeUpload(id)   │                     │                   │                  │                  │
   │                      │─────────────────────►│                     │                   │                  │                  │
   │                      │                      │                     │                   │                  │                  │
   │                      │                      │    complete(parts)  │                   │                  │                  │
   │                      │                      │────────────────────►│                   │                  │                  │
   │                      │                      │                     │                   │                  │                  │
   │                      │                      │   storagePath       │                   │                  │                  │
   │                      │                      │◄────────────────────│                   │                  │                  │
   │                      │                      │                     │                   │                  │                  │
   │                      │                      │ 准备本地文件 (下载或使用缓存)            │                  │                  │
   │                      │                      │ context.put(LOCAL_FILE_PATH, path)      │                  │                  │
   │                      │                      │                     │                   │                  │                  │
   │                      │                      │   状态 → PROCESSING │                   │                  │                  │
   │                      │                      │                     │                   │                  │                  │
   │                      │                      │  for each callback:                     │                  │                  │
   │                      │                      │────────────────────────────────────────►│                  │                  │
   │                      │                      │                     │  getPlugin(name)  │                  │                  │
   │                      │                      │                     │                   │─────────────────►│                  │
   │                      │                      │                     │        plugin     │                  │                  │
   │                      │                      │◄────────────────────────────────────────│                  │                  │
   │                      │                      │                     │                   │                  │                  │
   │                      │                      │            apply(taskContext)           │                  │                  │
   │                      │                      │────────────────────────────────────────────────────────────►│                  │
   │                      │                      │                     │                   │                  │                  │
   │                      │                      │            PluginResult                 │                  │                  │
   │                      │                      │◄────────────────────────────────────────────────────────────│                  │
   │                      │                      │                     │                   │                  │                  │
   │                      │                      │   清理本地临时文件   │                   │                  │                  │
   │                      │                      │   状态 → COMPLETED  │                   │                  │                  │
   │                      │                      │   绑定 FileReference                    │                  │                  │
   │                      │                      │                     │                   │                  │                  │
   │                      │                      │                     send(TaskCompletedEvent)               │                  │
   │                      │                      │─────────────────────────────────────────────────────────────────────────────────►│
   │                      │                      │                     │                   │                  │                  │
   │                      │    TaskInfoDto       │                     │                   │                  │                  │
   │                      │◄─────────────────────│                     │                   │                  │                  │
   │                      │                      │                     │                   │                  │                  │
   │   200 {COMPLETED}    │                      │                     │                   │                  │                  │
   │◄─────────────────────│                      │                     │                   │                  │                  │
```

## 五、分层职责

```
┌────────────────────────────────────────────────────────────────────────────┐
│                         Interface Layer (接口层)                           │
├────────────────────────────────────────────────────────────────────────────┤
│  TaskController                                                            │
│  - 接收 HTTP 请求，参数校验                                                  │
│  - 调用 Application Service                                                │
│  - 返回 TaskInfoDto                                                        │
└────────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌────────────────────────────────────────────────────────────────────────────┐
│                        Application Layer (应用层)                          │
├────────────────────────────────────────────────────────────────────────────┤
│  TaskService                                                               │
│  - 编排业务流程 (创建任务、上传分片、完成、中止)                               │
│  - 调用 Domain Service 和 Infrastructure                                   │
│  - 管理事务边界                                                             │
│  - 执行 Plugin Callback 链                                                 │
└────────────────────────────────────────────────────────────────────────────┘
                                     │
                    ┌────────────────┴────────────────┐
                    ▼                                 ▼
┌───────────────────────────────────┐  ┌───────────────────────────────────┐
│      Domain Layer (领域层)         │  │   Infrastructure Layer (基础设施)  │
├───────────────────────────────────┤  ├───────────────────────────────────┤
│  TaskAggregate                    │  │  StorageAdapter                   │
│  - 任务状态机管理                  │  │  - put / get / delete / exists    │
│  - 分片记录                        │  │  - beginUpload() → UploadSession  │
│  - callback 索引跟踪              │  │                                   │
│  - 业务规则校验                    │  │  PluginRegistry                   │
│                                   │  │  - getPlugin(name)                │
│  TaskRepository (接口)            │  │  - Plugin 生命周期管理              │
│  - 持久化任务状态                  │  │                                   │
└───────────────────────────────────┘  └───────────────────────────────────┘
```

### 5.1 各层职责详解

| 层                 | 组件           | 职责                             |
| ------------------ | -------------- | -------------------------------- |
| **Interface**      | TaskController | REST API、参数绑定、异常转换     |
| **Application**    | TaskService    | 流程编排、事务、调用 Plugin      |
| **Domain**         | TaskAggregate  | 状态机、业务规则、聚合根         |
| **Domain**         | TaskRepository | 持久化接口 (由 Infra 实现)       |
| **SPI (common)**   | StorageAdapter | 对象存储抽象，返回 UploadSession |
| **SPI (common)**   | UploadSession  | 封装分片上传细节                 |
| **SPI (common)**   | SharedPlugin   | Plugin SPI 接口                  |
| **Infrastructure** | PluginRegistry | Plugin 发现与获取                |

## 六、数据模型

### 6.1 TaskAggregate (聚合根)

```java
@Entity
@Table(name = "upload_task")
public class TaskAggregate {

    @Id
    private String taskId;              // UUID，任务唯一标识

    private String fKey;                // 文件唯一标识 (UUID)

    @Enumerated(EnumType.STRING)
    private TaskStatus status;          // PENDING → IN_PROGRESS → PROCESSING → COMPLETED/FAILED/...
                                        // TaskStatus已移至common.vo.task包，作为共享值对象

    private String nodeId;              // 当前处理节点 (集群场景)
    private String sessionId;           // 存储层上传会话 ID (S3 uploadId 等)
    private String storagePath;         // 最终存储路径 (完成后填充)

    private String hash;                // 文件哈希 (用于去重)
    private Long totalSize;             // 文件总大小
    private String contentType;         // MIME类型
    private String filename;            // 文件名

    @ElementCollection
    private List<PartInfo> parts;       // 已上传分片列表

    @ElementCollection
    private List<CallbackConfig> callbacks;  // 待执行 Plugin 列表

    private int currentCallbackIndex;   // 当前执行到第几个 callback (支持断点恢复)

    @Embedded
    private TaskContext context;        // Plugin 执行上下文 (参数 + 输出)

    private String failureReason;       // 失败原因

    private Instant createdAt;
    private Instant expiresAt;          // 超时时间
    private Instant completedAt;

    // === 领域行为 ===
    public void startUpload(String sessionId, String nodeId) { ... }
    public void recordPart(PartInfo part) { ... }
    public void completeUpload(String storagePath, String hash, Long totalSize, 
                               String contentType, String filename) { ... }
    public void advanceCallback() { ... }
    public void markCompleted() { ... }
    public void markFailed(String reason) { ... }
    public void abort() { ... }
}
```

**架构变更说明**：
- `TaskStatus` 从 `core.domain.tasks` 移至 `common.vo.task`
- 原因：TaskStatus是跨层共享的枚举，作为值对象应放在common模块
- 避免circular dependency：common模块中的TaskSummary需要引用TaskStatus

### 6.2 PartInfo (值对象)

```java
@Embeddable
public record PartInfo(
    int partNumber,     // 分片序号 (1-based)
    String etag,        // 存储层返回的 ETag
    long size           // 分片大小
) {}
```

### 6.3 TaskContext (值对象)

```java
@Embeddable
@Convert(converter = TaskContextConverter.class)  // JSON 序列化
public class TaskContext {

    private Map<String, Object> data = new HashMap<>();

    // === 读取 ===
    public Optional<Object> get(String key) { ... }
    public String requireString(String key) { ... }
    public <T> T require(String key, Class<T> type) { ... }

    // === 写入 (Plugin 追加输出) ===
    public void put(String key, Object value) { ... }

    // === 读取 Plugin 特定参数 ===
    /** 获取 pluginName.paramKey 格式的参数 */
    public Optional<Object> getPluginParam(String pluginName, String paramKey) {
        return get(pluginName + "." + paramKey);
    }

    // === 内置 Key ===
    public static final String KEY_STORAGE_PATH = "storagePath";       // 存储层路径
    public static final String KEY_LOCAL_FILE_PATH = "localFilePath";  // 本地临时文件路径
    public static final String KEY_FILE_HASH = "fileHash";             // 文件哈希
    public static final String KEY_CONTENT_TYPE = "contentType";       // MIME 类型
    public static final String KEY_FILE_SIZE = "fileSize";             // 文件大小
    public static final String KEY_FILENAME = "filename";              // 原始文件名
    public static final String KEY_DERIVED_FILES = "derivedFiles";     // 衍生文件列表 List<DerivedFile>
    public static final String KEY_METADATA_CHANGES = "_metadataChanges"; // 元数据变更记录（内部）

    // === 元数据字段常量 ===
    public static final String METADATA_FILENAME = "filename";         // 文件名字段
    public static final String METADATA_CONTENT_TYPE = "contentType";  // MIME 类型字段

    // === 元数据修改（供元数据修改类插件使用）===
    /**
     * 设置元数据字段值（通用方法）
     * callback 链成功后由 TaskService 应用到 FileReference
     * @param field 字段名，使用 METADATA_* 常量
     * @param value 新值
     */
    public void setMetadata(String field, String value) {
        getMetadataChanges().put(field, value);
    }

    /** 获取元数据变更记录 */
    public Map<String, String> getMetadataChanges() { ... }

    /** 是否有元数据变更 */
    public boolean hasMetadataChanges() { ... }

    // === 衍生文件操作（供衍生文件生成类插件使用）===
    /** 添加衍生文件 */
    public void addDerivedFile(DerivedFile derivedFile) { ... }

    /** 获取衍生文件列表 */
    public List<DerivedFile> getDerivedFiles() { ... }
}
```

### 6.4 领域事件

```java
/** 任务完成事件 - 发送到 Kafka */
public record TaskCompletedEvent(
    String taskId,
    FKey fKey,
    String fKeyString,           // 序列化后的 fKey，便于下游解析
    String storagePath,
    String contentHash,
    Long fileSize,
    String contentType,
    List<DerivedFile> derivedFiles,  // 衍生文件（缩略图等）
    Map<String, Object> pluginOutputs, // 各 Plugin 输出
    Instant completedAt
) {}

/** 任务失败事件 - 发送到 Kafka */
public record TaskFailedEvent(
    String taskId,
    FKey fKey,
    String fKeyString,
    TaskStatus finalStatus,      // FAILED / ABORTED / EXPIRED
    String failureReason,
    int lastCallbackIndex,       // 失败时执行到第几个 callback
    Instant failedAt
) {}
```

### 6.5 PluginResult (值对象)

```java
public sealed interface PluginResult {

    record Success(Map<String, Object> outputs) implements PluginResult {}

    record Failure(String reason, boolean retryable) implements PluginResult {}

    record Skip(String reason) implements PluginResult {}  // 跳过但不失败
}
```

### 6.6 DerivedFile (值对象)

```java
/** 衍生文件，由 Plugin 生成（如缩略图） */
public record DerivedFile(
    String type,          // 类型标识："thumbnail", "preview", "watermarked"
    String storagePath,   // 存储路径
    String contentType,   // MIME 类型
    Long size,            // 文件大小
    Map<String, Object> metadata  // 额外元数据，如 {"width": 200, "height": 200}
) {}
```

## 七、接口设计

### 7.1 StorageAdapter (修订)

```java
public interface StorageAdapter {

    // === 简单文件操作 ===
    void put(String path, InputStream data, long size, String contentType);
    InputStream get(String path);
    void delete(String path);
    boolean exists(String path);

    // === 预签名下载 ===
    URI presignDownload(String path, Duration expiry);

    // === 分片上传 ===
    /**
     * 开始新的分片上传会话
     * @param path 存储路径
     * @param contentType MIME类型
     * @return 上传会话对象
     */
    UploadSession beginUpload(String path, String contentType);

    /**
     * 恢复已存在的分片上传会话
     * @param path 存储路径
     * @param sessionId 会话ID
     * @return 上传会话对象
     * @throws IllegalStateException 如果会话不存在或已过期
     */
    UploadSession resumeUpload(String path, String sessionId);
}
```

**重要变更**：
- 新增 `resumeUpload()` 方法用于恢复已存在的上传会话
- 应用层（TaskService）不再包含降级逻辑
- 防腐层（StorageAdapter实现）负责处理存储层差异
- 如果底层存储不支持resumeUpload，Adapter应抛出异常，不应静默降级

### 7.2 UploadSession (新增)

```java
public interface UploadSession extends AutoCloseable {

    /**
     * 获取会话 ID (用于持久化和恢复)
     */
    String getSessionId();

    /**
     * 获取存储路径
     */
    String getPath();

    /**
     * 上传单个分片
     * @param partNumber 分片序号（1-based）
     * @param data 分片数据流
     * @param size 分片大小
     * @return 该分片的 ETag（不包含引号）
     */
    String uploadPart(int partNumber, InputStream data, long size);

    /**
     * 完成上传，合并所有分片
     * @param parts 所有分片信息 (partNumber + etag)
     * @return 最终文件的存储路径
     * @throws IllegalStateException 如果分片缺失或ETag不匹配
     */
    String complete(List<PartETagInfo> parts);

    /**
     * 中止上传，清理已上传的分片
     * 幂等操作，重复调用不应报错
     */
    void abort();

    /**
     * 资源释放
     * 注意：close()不应销毁session，只有complete()或abort()才真正清理
     * 这样才能支持resumeUpload()复用同一session
     */
    @Override
    void close();
}
```

**ETag格式约定**：
- `uploadPart()` 返回的ETag应为纯hash值，不包含引号
- 与HTTP ETag header格式不同（HTTP中ETag通常带引号如`"abc123"`）
- Adapter实现需要标准化ETag格式（移除引号等）

### 7.3 SharedPlugin (修订)

```java
public interface SharedPlugin {

    /**
     * 插件唯一标识
     */
    String name();

    /**
     * 初始化 (容器启动时调用)
     */
    default void init() {}

    /**
     * 执行插件逻辑
     * @param context 上下文，可读取参数、追加输出
     * @return 执行结果
     */
    PluginResult apply(TaskContext context);

    /**
     * 资源释放 (容器关闭时调用)
     */
    default void release() {}
}
```

### 7.4 插件类型分类

根据插件的操作行为，分为三种类型：

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                          Plugin 类型分类                                      │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │  类型 A: 元数据修改类                                                    │ │
│  ├────────────────────────────────────────────────────────────────────────┤ │
│  │  代表插件: rename, tag, classify                                        │ │
│  │  操作对象: FileReference 的属性 (filename, contentType 等)              │ │
│  │  操作方式: ctx.setMetadata(METADATA_FILENAME, value)                    │ │
│  │  返回结果: PluginResult.Success.empty()                                 │ │
│  │  特点: 不生成新文件，只修改元数据；变更在 callback 链成功后统一应用        │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │  类型 B: 衍生文件生成类                                                  │ │
│  ├────────────────────────────────────────────────────────────────────────┤ │
│  │  代表插件: thumbnail, transcode, watermark, preview                     │ │
│  │  操作对象: 基于原始文件生成新文件                                         │ │
│  │  操作方式: 生成文件 → 上传存储层 → ctx.addDerivedFile()                  │ │
│  │  返回结果: PluginResult.Success.empty()                                 │ │
│  │  特点: 创建新文件并关联到主文件的 FileReference；需注入 StorageAdapter    │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │  类型 C: 数据传递类                                                      │ │
│  ├────────────────────────────────────────────────────────────────────────┤ │
│  │  代表插件: hash-verify, virus-scan, content-detect, exif-extract        │ │
│  │  操作对象: 验证或提取信息，写入 TaskContext                               │ │
│  │  操作方式: ctx.put("pluginName.key", value)                             │ │
│  │  返回结果: Success / Failure / Skip                                     │ │
│  │  特点: 不修改元数据，不生成文件；结果供后续插件使用；验证失败可阻断链路    │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

#### 7.4.1 类型 A: 元数据修改类插件

**操作逻辑：**

```
1. 从 TaskContext 读取插件参数 (ctx.getPluginString(name, key))
2. 从 TaskContext 读取当前文件信息 (ctx.getString(KEY_FILENAME) 等)
3. 执行业务逻辑计算新值
4. 通过 ctx.setMetadata(field, value) 记录变更
5. 返回 PluginResult.Success.empty()
```

**示例 - RenamePlugin：**

```java
public class RenamePlugin implements SharedPlugin {

    @Override
    public PluginResult apply(TaskContext ctx) {
        // 读取参数
        String pattern = ctx.getPluginString("rename", "pattern")
                .orElse("{fullname}");
        String originalName = ctx.getString(TaskContext.KEY_FILENAME).orElse("unknown");

        // 计算新文件名
        String newName = pattern
                .replace("{filename}", getBaseName(originalName))
                .replace("{ext}", getExtension(originalName))
                .replace("{uuid}", UUID.randomUUID().toString());

        // 记录元数据变更（由 TaskService 在 callback 链成功后应用）
        ctx.setMetadata(TaskContext.METADATA_FILENAME, newName);

        return PluginResult.Success.empty();
    }
}
```

**事务性保证：**

- 元数据变更记录在 `TaskContext._metadataChanges` 中
- 所有 callback 成功后，TaskService 统一应用变更到 FileReference
- 任一 callback 失败，所有变更都不会生效

#### 7.4.2 类型 B: 衍生文件生成类插件

**操作逻辑：**

```
1. 从 TaskContext 读取插件参数
2. 从 TaskContext 获取本地文件路径 (KEY_LOCAL_FILE_PATH)
3. 读取原始文件，执行处理逻辑（图片缩放、视频转码等）
4. 将生成的文件上传到存储层（通过注入的 StorageAdapter）
5. 通过 ctx.addDerivedFile() 记录衍生文件信息
6. 清理处理过程中的临时文件
7. 返回 PluginResult.Success.empty()
```

**示例 - ThumbnailPlugin：**

```java
public class ThumbnailPlugin implements SharedPlugin {

    private final StorageAdapter storageAdapter;  // 依赖注入

    @Override
    public PluginResult apply(TaskContext ctx) {
        // 读取参数
        int width = ctx.getPluginInt("thumbnail", "width").orElse(200);
        int height = ctx.getPluginInt("thumbnail", "height").orElse(200);
        String format = ctx.getPluginString("thumbnail", "format").orElse("webp");

        // 获取源文件
        String localPath = ctx.requireString(TaskContext.KEY_LOCAL_FILE_PATH);
        String storagePath = ctx.requireString(TaskContext.KEY_STORAGE_PATH);

        // 生成缩略图
        Path thumbnailPath = generateThumbnail(localPath, width, height, format);

        // 上传到存储层
        String thumbnailStoragePath = buildDerivedPath(storagePath, "thumbnail", format);
        storageAdapter.put(thumbnailStoragePath, Files.newInputStream(thumbnailPath),
                          Files.size(thumbnailPath), "image/" + format);

        // 记录衍生文件
        ctx.addDerivedFile(DerivedFile.builder()
                .type("THUMBNAIL")
                .fileId(UUID.randomUUID().toString())
                .path(thumbnailStoragePath)
                .contentType("image/" + format)
                .size(Files.size(thumbnailPath))
                .build());

        // 清理临时文件
        Files.deleteIfExists(thumbnailPath);

        return PluginResult.Success.empty();
    }
}
```

**衍生文件存储路径约定：**

```
原始文件:  /ab/abcd1234/abcd1234567890.jpg
缩略图:    /ab/abcd1234/abcd1234567890_thumbnail.webp
预览图:    /ab/abcd1234/abcd1234567890_preview.jpg
转码文件:  /ab/abcd1234/abcd1234567890_transcode.mp4
```

#### 7.4.3 类型 C: 数据传递类插件

**操作逻辑：**

```
1. 从 TaskContext 读取插件参数
2. 从 TaskContext 获取待验证/分析的数据
3. 执行验证或计算逻辑
4. 通过 ctx.put(key, value) 写入结果供后续插件使用
5. 根据结果返回 Success / Failure / Skip
```

**示例 - HashVerifyPlugin：**

```java
public class HashVerifyPlugin implements SharedPlugin {

    @Override
    public PluginResult apply(TaskContext ctx) {
        // 读取参数
        String expectedHash = ctx.getPluginString("hash-verify", "expected").orElse(null);
        boolean strict = ctx.getPluginString("hash-verify", "strict")
                .map(Boolean::parseBoolean).orElse(true);

        // 获取实际哈希
        String actualHash = ctx.getString(TaskContext.KEY_FILE_HASH).orElse(null);

        // 无期望值则跳过
        if (expectedHash == null) {
            return PluginResult.Skip.of("No expected hash provided");
        }

        // 执行校验
        boolean verified = expectedHash.equalsIgnoreCase(actualHash);

        // 写入结果供后续插件使用
        ctx.put("hash-verify.verified", verified);
        ctx.put("hash-verify.actualHash", actualHash);

        // 根据结果返回
        if (verified) {
            return PluginResult.Success.empty();
        } else if (strict) {
            return PluginResult.Failure.of("Hash mismatch: expected=" + expectedHash + ", actual=" + actualHash);
        } else {
            ctx.put("hash-verify.warning", "Hash mismatch");
            return PluginResult.Success.empty();
        }
    }
}
```

**典型应用场景：**

| 插件             | 用途           | 关键输出                                |
| ---------------- | -------------- | --------------------------------------- |
| `hash-verify`    | 验证文件完整性 | `hash-verify.verified`                  |
| `virus-scan`     | 病毒扫描       | `virus-scan.safe`, `virus-scan.threats` |
| `exif-extract`   | 提取图片 EXIF  | `exif.width`, `exif.height`, `exif.gps` |
| `content-detect` | 内容类型检测   | `content-detect.realType`               |

### 7.5 PluginRegistry (新增)

```java
public interface PluginRegistry {

    /**
     * 根据名称获取插件
     * @throws PluginNotFoundException 插件不存在
     */
    SharedPlugin getPlugin(String name);

    /**
     * 检查插件是否存在
     */
    boolean hasPlugin(String name);

    /**
     * 获取所有注册的插件名称
     */
    Set<String> getRegisteredPlugins();
}
```

### 7.6 TaskService (应用服务)

```java
@Service
public class TaskService {

    /**
     * 创建上传任务
     * @param fKey 用户文件标识
     * @param hash 文件哈希 (可选，用于去重)
     * @param callbacks 逗号分隔的 Plugin 名称
     * @param params 初始参数 (存入 TaskContext)
     */
    public TaskInfoDto createTask(FKey fKey, String hash, String callbacks, Map<String, Object> params);

    /**
     * 上传分片
     */
    public PartETagDto uploadPart(String taskId, int partNumber, InputStream data, long size);

    /**
     * 完成上传，触发 Callback 链
     */
    public TaskInfoDto completeUpload(String taskId);

    /**
     * 中止任务
     */
    public void abortTask(String taskId);

    /**
     * 查询任务状态
     */
    public TaskInfoDto getTask(String taskId);

    /**
     * 批量查询任务
     */
    public List<TaskSummary> listTasks(FKey fKey, TaskStatus status, Pageable pageable);
}
```

### 7.7 TaskEventPublisher (事件发布)

```java
public interface TaskEventPublisher {

    /**
     * 发布任务完成事件到 Kafka
     */
    void publishCompleted(TaskCompletedEvent event);

    /**
     * 发布任务失败事件到 Kafka
     */
    void publishFailed(TaskFailedEvent event);
}
```

### 7.8 LocalFileManager (本地文件管理)

```java
public interface LocalFileManager {

    /**
     * 准备本地文件供 Plugin 处理
     * - 如果有上传缓存，直接返回缓存路径
     * - 否则从存储层下载到本地临时目录
     * @return 本地文件路径
     */
    Path prepareLocalFile(String storagePath, String taskId);

    /**
     * 清理任务的本地临时文件
     */
    void cleanup(String taskId);

    /**
     * 获取临时目录（供 Plugin 写入衍生文件）
     */
    Path getTempDirectory(String taskId);
}
```

## 八、状态流转规则

### 8.1 状态机

```
                              ┌──────────┐
                              │  EXPIRED │
                              └──────────┘
                                   ▲
                                   │ 超时
        ┌─────────┐  startUpload  ┌┴───────────┐  completeUpload  ┌────────────┐
        │ PENDING │──────────────►│ IN_PROGRESS│─────────────────►│ PROCESSING │
        └─────────┘               └────────────┘                  └────────────┘
             │                          │                              │
             │ abort                    │ abort                        │ callbacks 全部成功
             ▼                          ▼                              ▼
        ┌─────────┐               ┌─────────┐                    ┌───────────┐
        │ ABORTED │               │ ABORTED │                    │ COMPLETED │
        └─────────┘               └─────────┘                    └───────────┘
                                        │                              │
                                        │ uploadPart 失败              │ callback 失败
                                        ▼                              ▼
                                  ┌─────────┐                    ┌─────────┐
                                  │ FAILED  │                    │ FAILED  │
                                  └─────────┘                    └─────────┘
```

### 8.2 流转规则

| 当前状态    | 允许操作        | 目标状态    |
| ----------- | --------------- | ----------- |
| PENDING     | startUpload     | IN_PROGRESS |
| PENDING     | abort           | ABORTED     |
| PENDING     | 超时            | EXPIRED     |
| IN_PROGRESS | uploadPart      | IN_PROGRESS |
| IN_PROGRESS | completeUpload  | PROCESSING  |
| IN_PROGRESS | abort           | ABORTED     |
| IN_PROGRESS | 失败            | FAILED      |
| IN_PROGRESS | 超时            | EXPIRED     |
| PROCESSING  | advanceCallback | PROCESSING  |
| PROCESSING  | markCompleted   | COMPLETED   |
| PROCESSING  | 失败            | FAILED      |
| COMPLETED   | -               | (终态)      |
| FAILED      | -               | (终态)      |
| ABORTED     | -               | (终态)      |
| EXPIRED     | -               | (终态)      |

## 九、待修改文件清单

### 9.1 新增文件

| 模块     | 文件路径                                | 说明                    |
| -------- | --------------------------------------- | ----------------------- |
| core     | `domain/tasks/TaskAggregate.java`       | 任务聚合根              |
| core     | `domain/tasks/TaskRepository.java`      | 任务仓储接口            |
| core     | `domain/tasks/PartInfo.java`            | 分片信息值对象          |
| core     | `domain/events/TaskCompletedEvent.java` | 任务完成事件            |
| core     | `domain/events/TaskFailedEvent.java`    | 任务失败事件            |
| core     | `infra/plugin/PluginRegistry.java`      | 插件注册表接口          |
| core     | `infra/event/TaskEventPublisher.java`   | 事件发布接口            |
| core     | `infra/file/LocalFileManager.java`      | 本地文件管理接口        |
| common   | `spi/storage/UploadSession.java`        | 分片上传会话 SPI        |
| common   | `spi/storage/PartETagInfo.java`         | 分片 ETag 信息 (SPI 层) |
| common   | `spi/plugin/PluginResult.java`          | 插件执行结果            |
| common   | `context/TaskContext.java`              | 填充实现                |
| common   | `vo/DerivedFile.java`                   | 衍生文件值对象          |
| adapters | `hcs/HcsUploadSession.java`             | HCS 实现                |

### 9.2 修改文件

| 模块              | 文件路径                               | 变更内容                                         |
| ----------------- | -------------------------------------- | ------------------------------------------------ |
| common            | `spi/storage/StorageAdapter.java`      | 新增 `beginUpload()` 方法                        |
| common            | `spi/plugin/SharedPlugin.java`         | `apply()` 返回 `PluginResult`                    |
| core              | `application/service/TaskService.java` | 实现完整流程                                     |
| adapters          | `hcs/HcsStorageAdapter.java`           | 实现 `beginUpload()`                             |
| autoconfiguration | `FileServiceAutoConfiguration.java`    | 注册 `PluginRegistry`、`TaskEventPublisher` Bean |

### 9.3 依赖配置

```xml
<!-- Kafka 事件发布 -->
<dependency>
    <groupId>org.springframework.kafka</groupId>
    <artifactId>spring-kafka</artifactId>
</dependency>
```

### 9.4 配置项

```yaml
file-service:
  task:
    # 本地临时文件目录
    temp-dir: ${java.io.tmpdir}/file-srv-tasks
    # 临时文件保留时间（用于清理）
    temp-file-ttl: 1h
    # 任务超时时间
    expire-after: 24h

  kafka:
    topic:
      task-completed: file-task-completed
      task-failed: file-task-failed
```

## 十、缓存与防护设计

### 10.1 缓存策略

```
┌──────────────────────────────────────────────────────────────────────────┐
│                         缓存分层架构                                       │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  请求 ──►┌────────────────┐    MISS    ┌────────────────┐               │
│          │  L1: 本地缓存   │───────────►│  L2: Redis     │               │
│          │  Caffeine       │            │                │               │
│          │  TTL: 30s       │◄───────────│  TTL: 5min     │               │
│          └────────────────┘    HIT     └────────────────┘               │
│                 │                              │                         │
│                 │ MISS                         │ MISS                    │
│                 ▼                              ▼                         │
│          ┌─────────────────────────────────────────────┐                │
│          │              数据库 (PostgreSQL)             │                │
│          └─────────────────────────────────────────────┘                │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

| 缓存层    | 技术     | TTL  | 适用场景         |
| --------- | -------- | ---- | ---------------- |
| L1 本地   | Caffeine | 30s  | 热点任务状态查询 |
| L2 分布式 | Redis    | 5min | 跨实例共享       |

**缓存 Key 设计**：

```
task:{taskId}           → TaskAggregate JSON
task:fkey:{fKey}        → List<taskId>
task:exists:{taskId}    → "1" (存在标记，用于穿透防护)
```

### 10.2 无效 ID 防护

防止恶意请求导致缓存穿透：

```
┌──────────────────────────────────────────────────────────────────────────┐
│                      无效 ID 防护流程                                      │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  getTask(taskId)                                                         │
│       │                                                                  │
│       ▼                                                                  │
│  ┌─────────────────────┐                                                │
│  │ 1. 格式校验          │  ────► 非 UUID 格式，直接拒绝                   │
│  │    UUID 格式检查     │                                                │
│  └─────────────────────┘                                                │
│       │ 通过                                                             │
│       ▼                                                                  │
│  ┌─────────────────────┐                                                │
│  │ 2. 布隆过滤器检查    │  ────► 不存在，直接返回 404                     │
│  │    BloomFilter      │        (可能误判，但大幅减少穿透)                │
│  └─────────────────────┘                                                │
│       │ 可能存在                                                         │
│       ▼                                                                  │
│  ┌─────────────────────┐                                                │
│  │ 3. 缓存查询          │  ────► 命中则返回                              │
│  └─────────────────────┘                                                │
│       │ 未命中                                                           │
│       ▼                                                                  │
│  ┌─────────────────────┐                                                │
│  │ 4. 数据库查询        │                                                │
│  │    + 空值缓存        │  ────► 不存在则缓存空标记 (TTL: 1min)          │
│  └─────────────────────┘                                                │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

### 10.3 接口设计

```java
/** 任务缓存服务 */
public interface TaskCacheService {

    /** 获取任务（优先缓存） */
    Optional<TaskAggregate> getTask(String taskId);

    /** 缓存任务 */
    void cacheTask(TaskAggregate task);

    /** 失效缓存 */
    void evictTask(String taskId);

    /** 检查 taskId 是否可能存在（布隆过滤器） */
    boolean mightExist(String taskId);

    /** 注册 taskId 到布隆过滤器 */
    void registerTaskId(String taskId);
}

/** ID 验证器 */
public interface TaskIdValidator {

    /** 验证 taskId 格式 */
    boolean isValidFormat(String taskId);

    /** 快速判断是否可能存在 */
    boolean mightExist(String taskId);
}
```

### 10.4 TaskService 集成

```java
@Service
public class TaskService {

    private final TaskCacheService cacheService;
    private final TaskIdValidator idValidator;

    public TaskInfoDto getTask(String taskId) {
        // 1. 格式校验
        if (!idValidator.isValidFormat(taskId)) {
            throw new InvalidTaskIdException(taskId);
        }

        // 2. 布隆过滤器快速检查
        if (!idValidator.mightExist(taskId)) {
            throw new TaskNotFoundException(taskId);
        }

        // 3. 缓存查询
        Optional<TaskAggregate> cached = cacheService.getTask(taskId);
        if (cached.isPresent()) {
            return toDto(cached.get());
        }

        // 4. 数据库查询
        TaskAggregate task = taskRepository.findByTaskId(taskId)
            .orElseThrow(() -> new TaskNotFoundException(taskId));

        // 5. 回填缓存
        cacheService.cacheTask(task);

        return toDto(task);
    }

    @Transactional
    public TaskInfoDto.Pending createTask(...) {
        // ... 创建逻辑

        // 注册到布隆过滤器
        idValidator.registerTaskId(task.getTaskId());

        // 缓存
        cacheService.cacheTask(task);

        return ...;
    }
}
```

### 10.5 配置项

```yaml
file-service:
  cache:
    # 本地缓存配置
    local:
      enabled: true
      max-size: 10000
      ttl: 30s
    # Redis 缓存配置
    redis:
      enabled: true
      ttl: 5m
      key-prefix: "file-srv:task:"
    # 布隆过滤器配置
    bloom-filter:
      enabled: true
      expected-insertions: 1000000
      false-positive-rate: 0.01
    # 空值缓存
    null-cache:
      enabled: true
      ttl: 1m
```

### 10.6 新增文件清单

| 模块   | 文件路径                                           | 说明             |
| ------ | -------------------------------------------------- | ---------------- |
| core   | `infra/cache/TaskCacheService.java`                | 任务缓存服务接口 |
| core   | `infra/cache/TaskIdValidator.java`                 | ID 验证器接口    |
| core   | `infra/cache/impl/CaffeineTaskCacheService.java`   | 本地缓存实现     |
| core   | `infra/cache/impl/RedisTaskCacheService.java`      | Redis 缓存实现   |
| core   | `infra/cache/impl/CompositeTaskCacheService.java`  | 多级缓存组合     |
| core   | `infra/cache/impl/BloomFilterTaskIdValidator.java` | 布隆过滤器实现   |
| common | `exception/InvalidTaskIdException.java`            | 无效 ID 异常     |
