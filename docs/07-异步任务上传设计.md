# 异步任务上传设计

## 一、设计目标

支持大文件分片上传 + 后处理 (Callback) 的完整流程：

| 能力 | 说明 |
|------|------|
| 分片上传 | 服务端中转模式，客户端 → file-srv → 存储层 |
| 后处理链 | 调用方指定 callbacks，按顺序执行 Plugin |
| 断点恢复 | 支持从中断点继续执行 |
| 状态追踪 | 完整的任务状态机 |

## 二、整体流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           完整生命周期                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────┐    ┌───────────┐    ┌──────────┐    ┌──────────────────────┐ │
│  │ 创建任务  │───►│ 分片上传   │───►│ 完成上传  │───►│ 执行 Callback 链     │ │
│  │ PENDING  │    │IN_PROGRESS│    │PROCESSING│    │                      │ │
│  └──────────┘    └───────────┘    └──────────┘    │ plugin1 ► plugin2 ►..│ │
│       │               │               │           └──────────────────────┘ │
│       │               │               │                      │             │
│       ▼               ▼               ▼                      ▼             │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                         异常分支                                      │  │
│  │  ABORTED (用户中止)  │  FAILED (上传/处理失败)  │  EXPIRED (超时)      │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│                                      │                                      │
│                                      ▼                                      │
│                              ┌──────────────┐                               │
│                              │  COMPLETED   │                               │
│                              │ 绑定FileRef  │                               │
│                              └──────────────┘                               │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 三、核心概念

### 3.1 任务 vs 文件

| 概念 | 生命周期 | 说明 |
|------|----------|------|
| **TaskAggregate** | 临时 | 上传任务，完成后可清理 |
| **FileReference** | 永久 | 用户文件引用，任务完成后绑定 |
| **FileInfo** | 永久 | 物理文件，多任务可能指向同一 FileInfo（去重） |

### 3.2 Callback 机制

- 调用方在 `createTask` 时指定 `callbacks` 参数
- 格式：`"plugin1,plugin2,plugin3"`（逗号分隔）
- 执行顺序：按参数顺序，顺序执行
- 参数传递：通过 `TaskContext`，Plugin 可追加输出供后续 Plugin 使用

## 四、时序图

### 4.1 创建任务

```
 Client                   TaskController           TaskService            TaskAggregate          TaskRepository
   │                           │                       │                       │                      │
   │  POST /tasks              │                       │                       │                      │
   │  {fKey, hash, callbacks}  │                       │                       │                      │
   │──────────────────────────►│                       │                       │                      │
   │                           │                       │                       │                      │
   │                           │  createTask(cmd)      │                       │                      │
   │                           │──────────────────────►│                       │                      │
   │                           │                       │                       │                      │
   │                           │                       │  new TaskAggregate()  │                      │
   │                           │                       │──────────────────────►│                      │
   │                           │                       │                       │                      │
   │                           │                       │       aggregate       │                      │
   │                           │                       │◄──────────────────────│                      │
   │                           │                       │                       │                      │
   │                           │                       │                 save(aggregate)              │
   │                           │                       │─────────────────────────────────────────────►│
   │                           │                       │                       │                      │
   │                           │    TaskInfoDto        │                       │                      │
   │                           │◄──────────────────────│                       │                      │
   │                           │                       │                       │                      │
   │    201 {taskId, status}   │                       │                       │                      │
   │◄──────────────────────────│                       │                       │                      │
```

### 4.2 上传分片

```
 Client                   TaskController           TaskService             StorageAdapter          UploadSession
   │                           │                       │                       │                      │
   │  PUT /tasks/{id}/parts    │                       │                       │                      │
   │  {partNumber, data}       │                       │                       │                      │
   │──────────────────────────►│                       │                       │                      │
   │                           │                       │                       │                      │
   │                           │  uploadPart(cmd)      │                       │                      │
   │                           │──────────────────────►│                       │                       │
   │                           │                       │                       │                      │
   │                           │                       │  [首次] beginUpload() │                      │
   │                           │                       │──────────────────────►│                      │
   │                           │                       │                       │                      │
   │                           │                       │     UploadSession     │                      │
   │                           │                       │◄──────────────────────│                      │
   │                           │                       │                       │                      │
   │                           │                       │           uploadPart(partNo, data)          │
   │                           │                       │─────────────────────────────────────────────►│
   │                           │                       │                       │                      │
   │                           │                       │              PartETag                        │
   │                           │                       │◄─────────────────────────────────────────────│
   │                           │                       │                       │                      │
   │                           │                       │  记录 part 到 aggregate                      │
   │                           │                       │                       │                      │
   │                           │   PartETagDto         │                       │                      │
   │                           │◄──────────────────────│                       │                      │
   │                           │                       │                       │                      │
   │    200 {partNo, etag}     │                       │                       │                      │
   │◄──────────────────────────│                       │                       │                      │
```

### 4.3 完成上传 + Callback 执行

```
 Client              TaskController         TaskService          UploadSession       PluginRegistry        Plugin
   │                      │                      │                     │                   │                  │
   │ POST /tasks/{id}/    │                      │                     │                   │                  │
   │      complete        │                      │                     │                   │                  │
   │─────────────────────►│                      │                     │                   │                  │
   │                      │                      │                     │                   │                  │
   │                      │ completeUpload(id)   │                     │                   │                  │
   │                      │─────────────────────►│                     │                   │                  │
   │                      │                      │                     │                   │                  │
   │                      │                      │    complete(parts)  │                   │                  │
   │                      │                      │────────────────────►│                   │                  │
   │                      │                      │                     │                   │                  │
   │                      │                      │   storagePath       │                   │                  │
   │                      │                      │◄────────────────────│                   │                  │
   │                      │                      │                     │                   │                  │
   │                      │                      │   状态 → PROCESSING │                   │                  │
   │                      │                      │                     │                   │                  │
   │                      │                      │  for each callback:                     │                  │
   │                      │                      │────────────────────────────────────────►│                  │
   │                      │                      │                     │  getPlugin(name)  │                  │
   │                      │                      │                     │                   │─────────────────►│
   │                      │                      │                     │        plugin     │                  │
   │                      │                      │◄────────────────────────────────────────│                  │
   │                      │                      │                     │                   │                  │
   │                      │                      │            apply(taskContext)           │                  │
   │                      │                      │────────────────────────────────────────────────────────────►│
   │                      │                      │                     │                   │                  │
   │                      │                      │            PluginResult                 │                  │
   │                      │                      │◄────────────────────────────────────────────────────────────│
   │                      │                      │                     │                   │                  │
   │                      │                      │   状态 → COMPLETED  │                   │                  │
   │                      │                      │   绑定 FileReference                    │                  │
   │                      │                      │                     │                   │                  │
   │                      │    TaskInfoDto       │                     │                   │                  │
   │                      │◄─────────────────────│                     │                   │                  │
   │                      │                      │                     │                   │                  │
   │   200 {COMPLETED}    │                      │                     │                   │                  │
   │◄─────────────────────│                      │                     │                   │                  │
```

## 五、分层职责

```
┌────────────────────────────────────────────────────────────────────────────┐
│                         Interface Layer (接口层)                           │
├────────────────────────────────────────────────────────────────────────────┤
│  TaskController                                                            │
│  - 接收 HTTP 请求，参数校验                                                  │
│  - 调用 Application Service                                                │
│  - 返回 TaskInfoDto                                                        │
└────────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌────────────────────────────────────────────────────────────────────────────┐
│                        Application Layer (应用层)                          │
├────────────────────────────────────────────────────────────────────────────┤
│  TaskService                                                               │
│  - 编排业务流程 (创建任务、上传分片、完成、中止)                               │
│  - 调用 Domain Service 和 Infrastructure                                   │
│  - 管理事务边界                                                             │
│  - 执行 Plugin Callback 链                                                 │
└────────────────────────────────────────────────────────────────────────────┘
                                     │
                    ┌────────────────┴────────────────┐
                    ▼                                 ▼
┌───────────────────────────────────┐  ┌───────────────────────────────────┐
│      Domain Layer (领域层)         │  │   Infrastructure Layer (基础设施)  │
├───────────────────────────────────┤  ├───────────────────────────────────┤
│  TaskAggregate                    │  │  StorageAdapter                   │
│  - 任务状态机管理                  │  │  - put / get / delete / exists    │
│  - 分片记录                        │  │  - beginUpload() → UploadSession  │
│  - callback 索引跟踪              │  │                                   │
│  - 业务规则校验                    │  │  PluginRegistry                   │
│                                   │  │  - getPlugin(name)                │
│  TaskRepository (接口)            │  │  - Plugin 生命周期管理              │
│  - 持久化任务状态                  │  │                                   │
└───────────────────────────────────┘  └───────────────────────────────────┘
```

### 5.1 各层职责详解

| 层 | 组件 | 职责 |
|----|------|------|
| **Interface** | TaskController | REST API、参数绑定、异常转换 |
| **Application** | TaskService | 流程编排、事务、调用 Plugin |
| **Domain** | TaskAggregate | 状态机、业务规则、聚合根 |
| **Domain** | TaskRepository | 持久化接口 (由 Infra 实现) |
| **Infrastructure** | StorageAdapter | 对象存储抽象，返回 UploadSession |
| **Infrastructure** | UploadSession | 封装分片上传细节 |
| **Infrastructure** | PluginRegistry | Plugin 发现与获取 |
| **Infrastructure** | SharedPlugin | Plugin SPI 接口 |

## 六、数据模型

### 6.1 TaskAggregate (聚合根)

```java
@Entity
@Table(name = "upload_task")
public class TaskAggregate {
    
    @Id
    private String taskId;              // UUID，任务唯一标识
    
    @Embedded
    private FKey fKey;                  // 用户文件标识 (appId + bizKey + path)
    
    @Enumerated(EnumType.STRING)
    private TaskStatus status;          // PENDING → IN_PROGRESS → PROCESSING → COMPLETED/FAILED/...
    
    private String nodeId;              // 当前处理节点 (集群场景)
    private String sessionId;           // 存储层上传会话 ID (S3 uploadId 等)
    private String storagePath;         // 最终存储路径 (完成后填充)
    
    private String hash;                // 文件哈希 (用于去重)
    private Long totalSize;             // 文件总大小
    
    @ElementCollection
    private List<PartInfo> parts;       // 已上传分片列表
    
    @ElementCollection
    private List<String> callbacks;     // 待执行 Plugin 列表
    
    private int currentCallbackIndex;   // 当前执行到第几个 callback (支持断点恢复)
    
    @Embedded
    private TaskContext context;        // Plugin 执行上下文 (参数 + 输出)
    
    private String failureReason;       // 失败原因
    
    private Instant createdAt;
    private Instant expiresAt;          // 超时时间
    private Instant completedAt;
    
    // === 领域行为 ===
    public void startUpload(String sessionId) { ... }
    public void recordPart(PartInfo part) { ... }
    public void completeUpload(String storagePath) { ... }
    public void advanceCallback() { ... }
    public void markCompleted() { ... }
    public void markFailed(String reason) { ... }
    public void abort() { ... }
}
```

### 6.2 PartInfo (值对象)

```java
@Embeddable
public record PartInfo(
    int partNumber,     // 分片序号 (1-based)
    String etag,        // 存储层返回的 ETag
    long size           // 分片大小
) {}
```

### 6.3 TaskContext (值对象)

```java
@Embeddable
@Convert(converter = TaskContextConverter.class)  // JSON 序列化
public class TaskContext {
    
    private Map<String, Object> data = new HashMap<>();
    
    // === 读取 ===
    public Optional<Object> get(String key) { ... }
    public String requireString(String key) { ... }
    public <T> T require(String key, Class<T> type) { ... }
    
    // === 写入 (Plugin 追加输出) ===
    public void put(String key, Object value) { ... }
    
    // === 内置 Key ===
    public static final String KEY_STORAGE_PATH = "storagePath";
    public static final String KEY_FILE_HASH = "fileHash";
    public static final String KEY_DERIVED_FILES = "derivedFiles";  // 衍生文件列表
}
```

### 6.4 PluginResult (值对象)

```java
public sealed interface PluginResult {
    
    record Success(Map<String, Object> outputs) implements PluginResult {}
    
    record Failure(String reason, boolean retryable) implements PluginResult {}
    
    record Skip(String reason) implements PluginResult {}  // 跳过但不失败
}
```

## 七、接口设计

### 7.1 StorageAdapter (修订)

```java
public interface StorageAdapter {
    
    // === 简单文件操作 ===
    void put(String path, InputStream data, long size, String contentType);
    InputStream get(String path);
    void delete(String path);
    boolean exists(String path);
    
    // === 预签名下载 ===
    URI presignDownload(String path, Duration expiry);
    
    // === 分片上传 ===
    UploadSession beginUpload(String path, String contentType);
}
```

### 7.2 UploadSession (新增)

```java
public interface UploadSession extends AutoCloseable {
    
    /**
     * 获取会话 ID (用于持久化和恢复)
     */
    String getSessionId();
    
    /**
     * 上传单个分片
     * @return 该分片的 ETag
     */
    String uploadPart(int partNumber, InputStream data, long size);
    
    /**
     * 完成上传，合并所有分片
     * @param parts 所有分片信息 (partNumber + etag)
     * @return 最终文件的存储路径
     */
    String complete(List<PartInfo> parts);
    
    /**
     * 中止上传，清理已上传的分片
     */
    void abort();
    
    /**
     * 资源释放
     */
    @Override
    void close();
}
```

### 7.3 SharedPlugin (修订)

```java
public interface SharedPlugin {
    
    /**
     * 插件唯一标识
     */
    String name();
    
    /**
     * 初始化 (容器启动时调用)
     */
    default void init() {}
    
    /**
     * 执行插件逻辑
     * @param context 上下文，可读取参数、追加输出
     * @return 执行结果
     */
    PluginResult apply(TaskContext context);
    
    /**
     * 资源释放 (容器关闭时调用)
     */
    default void release() {}
}
```

### 7.4 PluginRegistry (新增)

```java
public interface PluginRegistry {
    
    /**
     * 根据名称获取插件
     * @throws PluginNotFoundException 插件不存在
     */
    SharedPlugin getPlugin(String name);
    
    /**
     * 检查插件是否存在
     */
    boolean hasPlugin(String name);
    
    /**
     * 获取所有注册的插件名称
     */
    Set<String> getRegisteredPlugins();
}
```

### 7.5 TaskService (应用服务)

```java
@Service
public class TaskService {
    
    /**
     * 创建上传任务
     * @param fKey 用户文件标识
     * @param hash 文件哈希 (可选，用于去重)
     * @param callbacks 逗号分隔的 Plugin 名称
     * @param params 初始参数 (存入 TaskContext)
     */
    public TaskInfoDto createTask(FKey fKey, String hash, String callbacks, Map<String, Object> params);
    
    /**
     * 上传分片
     */
    public PartETagDto uploadPart(String taskId, int partNumber, InputStream data, long size);
    
    /**
     * 完成上传，触发 Callback 链
     */
    public TaskInfoDto completeUpload(String taskId);
    
    /**
     * 中止任务
     */
    public void abortTask(String taskId);
    
    /**
     * 查询任务状态
     */
    public TaskInfoDto getTask(String taskId);
    
    /**
     * 批量查询任务
     */
    public List<TaskSummary> listTasks(FKey fKey, TaskStatus status, Pageable pageable);
}
```

## 八、状态流转规则

### 8.1 状态机

```
                              ┌──────────┐
                              │  EXPIRED │
                              └──────────┘
                                   ▲
                                   │ 超时
        ┌─────────┐  startUpload  ┌┴───────────┐  completeUpload  ┌────────────┐
        │ PENDING │──────────────►│ IN_PROGRESS│─────────────────►│ PROCESSING │
        └─────────┘               └────────────┘                  └────────────┘
             │                          │                              │
             │ abort                    │ abort                        │ callbacks 全部成功
             ▼                          ▼                              ▼
        ┌─────────┐               ┌─────────┐                    ┌───────────┐
        │ ABORTED │               │ ABORTED │                    │ COMPLETED │
        └─────────┘               └─────────┘                    └───────────┘
                                        │                              │
                                        │ uploadPart 失败              │ callback 失败
                                        ▼                              ▼
                                  ┌─────────┐                    ┌─────────┐
                                  │ FAILED  │                    │ FAILED  │
                                  └─────────┘                    └─────────┘
```

### 8.2 流转规则

| 当前状态 | 允许操作 | 目标状态 |
|----------|----------|----------|
| PENDING | startUpload | IN_PROGRESS |
| PENDING | abort | ABORTED |
| PENDING | 超时 | EXPIRED |
| IN_PROGRESS | uploadPart | IN_PROGRESS |
| IN_PROGRESS | completeUpload | PROCESSING |
| IN_PROGRESS | abort | ABORTED |
| IN_PROGRESS | 失败 | FAILED |
| IN_PROGRESS | 超时 | EXPIRED |
| PROCESSING | advanceCallback | PROCESSING |
| PROCESSING | markCompleted | COMPLETED |
| PROCESSING | 失败 | FAILED |
| COMPLETED | - | (终态) |
| FAILED | - | (终态) |
| ABORTED | - | (终态) |
| EXPIRED | - | (终态) |

## 九、待修改文件清单

### 9.1 新增文件

| 模块 | 文件路径 | 说明 |
|------|----------|------|
| core | `domain/tasks/TaskAggregate.java` | 任务聚合根 |
| core | `domain/tasks/TaskRepository.java` | 任务仓储接口 |
| core | `domain/tasks/PartInfo.java` | 分片信息值对象 |
| core | `infra/storage/UploadSession.java` | 分片上传会话接口 |
| core | `infra/plugin/PluginRegistry.java` | 插件注册表接口 |
| core | `infra/plugin/PluginResult.java` | 插件执行结果 |
| common | `context/TaskContext.java` | 填充实现 |
| adapters | `hcs/HcsUploadSession.java` | HCS 实现 |

### 9.2 修改文件

| 模块 | 文件路径 | 变更内容 |
|------|----------|----------|
| core | `infra/storage/StorageAdapter.java` | 新增 `beginUpload()` 方法 |
| core | `infra/plugin/SharedPlugin.java` | `apply()` 返回 `PluginResult` |
| core | `application/service/TaskService.java` | 实现完整流程 |
| adapters | `hcs/HcsStorageAdapter.java` | 实现 `beginUpload()` |
| autoconfiguration | `FileServiceAutoConfiguration.java` | 注册 `PluginRegistry` Bean |

### 9.3 依赖配置

无新增外部依赖，复用现有 Spring Boot + JPA。

