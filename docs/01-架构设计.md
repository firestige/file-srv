# 架构设计

## 总览

ICC File Service 采用 **领域驱动设计（DDD）** 分层架构，结合适配器模式，通过 Spring Boot 自动装配加载存储后端，持久化元数据与任务状态，利用 Redis 做缓存，满足无状态横向扩容。

## DDD 分层架构

### 整体结构

```
┌─────────────────────────────────────────────────────────────────┐
│                       file-srv-core                             │
├─────────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────────┐  │
│  │              应用层 (application/)                         │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │  entrypoint/                                        │  │  │
│  │  │    ├── FileController      (文件操作 REST API)       │  │  │
│  │  │    ├── TaskController      (上传任务 REST API)       │  │  │
│  │  │    ├── StaticResourceController (静态资源访问)        │  │  │
│  │  │    ├── model/              (API层 请求/响应 DTO)     │  │  │
│  │  │    │    ├── FileInfoResponse   (文件信息响应)        │  │  │
│  │  │    │    ├── TaskResponse       (任务响应，sealed)    │  │  │
│  │  │    │    ├── MetaQueryRequest   (元数据查询请求)      │  │  │
│  │  │    │    └── PartETag           (分片ETag)           │  │  │
│  │  │    └── assembler/          (DTO转换器)              │  │  │
│  │  │         ├── FileInfoAssembler  (FileInfoDto ↔ Response)│  │
│  │  │         └── TaskInfoAssembler  (TaskInfoDto ↔ Response)│  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │  service/                                           │  │  │
│  │  │    ├── FileService         (文件应用服务)            │  │  │
│  │  │    ├── TaskService         (任务应用服务)            │  │  │
│  │  │    └── dto/                (应用层 DTO)             │  │  │
│  │  │         ├── FileInfoDto        (文件信息)           │  │  │
│  │  │         ├── TaskInfoDto        (任务信息，sealed)    │  │  │
│  │  │         ├── MetaQueryCriteria  (查询条件)           │  │  │
│  │  │         └── PartETagDto        (分片ETag)           │  │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │              领域层 (domain/)                              │  │
│  │    ├── files/                 (文件聚合)                   │  │
│  │    │    ├── FileReference     (用户文件引用，聚合根)        │  │
│  │    │    ├── FileInfo          (物理文件实体，去重核心)       │  │
│  │    │    ├── FileStatus        (文件状态枚举)               │  │
│  │    │    └── Repository        (仓储接口)                   │  │
│  │    ├── storage/               (存储聚合)                   │  │
│  │    │    ├── StorageNode       (存储节点)                   │  │
│  │    │    ├── StorageCopy       (存储副本)                   │  │
│  │    │    ├── StoragePolicy     (存储策略)                   │  │
│  │    │    └── Enums             (Tier/Status 枚举)          │  │
│  │    ├── services/              (领域服务)                   │  │
│  │    │    ├── DeduplicationService  (去重服务)               │  │
│  │    │    └── StorageRoutingService (路由服务)               │  │
│  │    └── tasks/                 (任务聚合，已有)              │  │
│  └───────────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │              基础设施层 (infra/)                           │  │
│  │    ├── storage/                                           │  │
│  │    │    ├── StorageAdapter        (存储适配器接口)         │  │
│  │    │    ├── StorageResult         (上传结果)              │  │
│  │    │    └── StorageAdapterRegistry(适配器注册中心)         │  │
│  │    └── plugin/                                            │  │
│  │         └── SharedPlugin          (插件接口)               │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

### 分层职责

| 层级 | 包路径 | 职责 |
|-----|--------|------|
| **应用层** | `application/` | 编排领域对象完成用例，暴露 REST API，DTO 转换 |
| **领域层** | `domain/` | 核心业务逻辑，聚合根、实体、值对象、领域服务 |
| **基础设施层** | `infra/` | 技术实现接口定义（存储、插件），具体实现在外部模块 |

### DTO 分层设计

应用层内部进一步划分为 **API 层**（entrypoint）和 **服务层**（service），各层拥有独立的 DTO 定义，通过 Assembler 进行显式转换。

#### 设计原则

| 概念 | 定义 | 跨层策略 | 示例 |
|------|------|----------|------|
| **VO（值对象）** | 与事实绑定的不可变数据 | 跨层共享 | `TaskStatus`、`FileRequest` |
| **DTO（数据传输对象）** | 与业务场景绑定的数据集合 | 每层各自定义 | `FileInfoDto` vs `FileInfoResponse` |

#### 层间 DTO 划分

```
┌─────────────────────────────────────────────────────────────────┐
│  API 层 (entrypoint/model)                                      │
│  ────────────────────────                                       │
│  职责：HTTP 传输，面向客户端                                      │
│  特征：@JsonTypeInfo, @JsonSubTypes, @Valid 等序列化/验证注解     │
│                                                                  │
│  FileInfoResponse    ──┐                                        │
│  TaskResponse        ──┼── 包含 JSON 多态序列化注解               │
│  MetaQueryRequest    ──┤   包含 Bean Validation 注解             │
│  PartETag            ──┘                                        │
└────────────────────────────────┬────────────────────────────────┘
                                 │ Assembler 转换
┌────────────────────────────────▼────────────────────────────────┐
│  服务层 (service/dto)                                            │
│  ────────────────────                                            │
│  职责：业务逻辑处理，面向领域层                                    │
│  特征：纯数据结构，无框架依赖注解                                  │
│                                                                  │
│  FileInfoDto         ──┐                                        │
│  TaskInfoDto         ──┼── 纯 Java 数据类（record / sealed）     │
│  MetaQueryCriteria   ──┤   无序列化/验证注解                      │
│  PartETagDto         ──┘                                        │
└─────────────────────────────────────────────────────────────────┘
```

#### Assembler 模式

Assembler 负责 API 层与服务层 DTO 的双向转换，集中管理转换逻辑：

```java
// FileInfoAssembler - 文件信息转换
public final class FileInfoAssembler {
    public static FileInfoResponse toResponse(FileInfoDto dto) { ... }
    public static MetaQueryCriteria toCriteria(MetaQueryRequest request) { ... }
}

// TaskInfoAssembler - 任务信息转换
public final class TaskInfoAssembler {
    public static TaskResponse toResponse(TaskInfoDto dto) { ... }
    public static PartETagDto toDto(PartETag partETag) { ... }
}
```

#### 设计收益

| 收益 | 说明 |
|------|------|
| **解耦** | 服务层不依赖 HTTP/JSON 框架注解，可独立测试 |
| **灵活** | API 层响应格式变化不影响业务逻辑 |
| **类型安全** | sealed interface 配合 record 实现编译期类型检查 |
| **职责清晰** | 验证在 API 层完成，服务层专注业务逻辑 |

## 模块依赖关系

```
                    ┌─────────────────────┐
                    │   file-srv-test     │  (集成测试)
                    └──────────┬──────────┘
                               │
                    ┌──────────▼──────────┐
                    │ file-srv-autoconfig │  (Spring 自动装配)
                    └──────────┬──────────┘
                               │
        ┌──────────────────────┼──────────────────────┐
        │                      │                      │
┌───────▼───────┐   ┌─────────▼─────────┐   ┌───────▼───────┐
│file-srv-aspect│   │  file-srv-adapters │   │file-srv-plugins│
│  (切面模块)    │   │   (存储适配器)      │   │   (插件模块)   │
└───────┬───────┘   └─────────┬─────────┘   └───────┬───────┘
        │                     │                     │
        │               ┌─────┴─────┐               │
        │               │           │               │
        └───────────────┤   core    │───────────────┘
                        │           │
                        └─────┬─────┘
                              │
                    ┌─────────▼─────────┐
                    │      common       │  (公共模块 + SPI 契约)
                    │  ┌─────────────┐  │
                    │  │    spi/     │  │
                    │  │ ├─storage/  │  │
                    │  │ └─plugin/   │  │
                    │  └─────────────┘  │
                    └───────────────────┘
```

说明：adapters 和 plugins 模块只依赖 common（获取 SPI 契约），不依赖 core。

## 关键设计点

- **DDD 分层**：领域逻辑集中在 `domain/`，应用编排在 `application/`，技术细节在 `infra/` 及外部模块
- **DTO 分层**：API 层与服务层各自定义 DTO，通过 Assembler 显式转换，解耦 HTTP 框架依赖
- **VO 共享**：与事实绑定的值对象（如 `TaskStatus`、`FileRequest`）跨层共享，避免重复定义
- **无状态服务**：会话/任务状态不落本地，依赖 DB + Redis，可水平扩容
- **多级缓存**：Caffeine 进程内热点 + Redis 分布式缓存，降低 DB/存储访问
- **配置驱动适配器加载**：`storage.obs.enabled=true` 触发华为云适配器自动装配
- **统一异常**：SDK/IO 异常转换为 `FileServiceException`，错误码集中在 `ResultCode`
- **插件机制**：上传完成后按顺序调用 `SharedPlugin` 实现后处理扩展
- **可观察性**：Spring Actuator 做健康检查、指标暴露

## 数据流

### 1. 同步上传
```
FileController.uploadFile()
    ↓
FileService.upload()
    ↓
StorageAdapter.uploadFile()  ──→  对象存储 (OBS/OSS/S3...)
    ↓
MetaService.save()  ──→  DB (FileEntity)
    ↓
返回 FileInfo
```

### 2. 分片上传
```
TaskController.createUploadTask()
    ↓
TaskService.create()  ──→  DB (TaskEntity) + Redis (状态缓存)
    ↓
StorageAdapter.initiateMultipartUpload()
    ↓
返回 TaskInfo (含 uploadId)

TaskController.uploadPart()
    ↓
TaskService.recordPart()
    ↓
StorageAdapter.uploadPart()
    ↓
返回 PartUploadInfo (含 eTag)

TaskController.completeUpload()
    ↓
StorageAdapter.completeMultipartUpload()
    ↓
SharedPlugin.apply() × N  (按顺序执行插件)
    ↓
MetaService.save()  ──→  DB (FileEntity)
    ↓
TaskService.complete()  ──→  更新状态
```

### 3. 下载
```
FileController.getFile() / StaticResourceController.staticResource()
    ↓
MetaService.findByFkey()  ←──  Caffeine → Redis → DB
    ↓
StorageAdapter.downloadFile()  或  generatePresignedUrl()
    ↓
返回 Resource / 重定向 URL
```

### 4. 删除
```
FileController.deleteFile()
    ↓
StorageAdapter.deleteFile()  ──→  删除对象存储文件
    ↓
MetaService.delete()  ──→  删除 DB 记录
    ↓
缓存失效  ──→  删除 Redis/Caffeine 缓存
```

## 组件交互示意

```
┌─────────────────────────────────────────────────────────────────┐
│                         应用层                                   │
│  FileController ─┬─→ FileService ─┬─→ StorageAdapter (接口)      │
│  TaskController ─┤                │                             │
│  StaticResource ─┘                └─→ MetaService (待实现)       │
│                                       TaskService (待实现)       │
└───────────────────────────┬─────────────────────────────────────┘
                            │
┌───────────────────────────▼─────────────────────────────────────┐
│                         领域层                                   │
│  FileAggregate ←──────────────────────→ TaskAggregate           │
│       │                                       │                  │
│  FileInfo (实体)                        TaskInfo (实体)          │
│                                         TaskStatus (枚举)        │
└───────────────────────────┬─────────────────────────────────────┘
                            │
┌───────────────────────────▼─────────────────────────────────────┐
│                       基础设施层                                 │
│                                                                  │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │ StorageAdapter  │  │  SharedPlugin   │  │   Repository    │  │
│  │    (接口)       │  │    (接口)       │  │    (JPA)        │  │
│  └────────┬────────┘  └────────┬────────┘  └─────────────────┘  │
└───────────┼────────────────────┼────────────────────────────────┘
            │ (实现在外部模块)     │ (实现在外部模块)
┌───────────▼───────────┐  ┌─────▼─────────────────┐
│   file-srv-adapters   │  │    file-srv-plugins   │
│  ┌─────────────────┐  │  │  ┌─────────────────┐  │
│  │ HcsObsAdapter   │  │  │  │ RenamePlugin    │  │
│  │ (华为云OBS)     │  │  │  │ (示例)          │  │
│  └─────────────────┘  │  │  └─────────────────┘  │
└───────────────────────┘  └───────────────────────┘
```

## 配置示例

```yaml
# 存储配置
storage:
  obs:
    enabled: true
    endpoint: https://obs.cn-north-4.myhuaweicloud.com
    bucket-name: ${OBS_BUCKET}
    access-key: ${OBS_ACCESS_KEY}
    secret-key: ${OBS_SECRET_KEY}
    presigned-url-expiration: 3600s

# Redis 配置
spring:
  redis:
    host: localhost
    port: 6379
  datasource:
    url: jdbc:mysql://localhost:3306/filesrv
    username: root
    password: ${DB_PASSWORD}
```

## 非功能性目标

- **可扩展性**：适配器接口稳定，新增存储零侵入业务层；插件机制支持后处理扩展
- **可靠性**：分片上传支持重试、幂等；任务状态可恢复
- **性能**：多级缓存、直连预签名下载、分片并发上传
- **安全**：凭证隔离（配置/环境变量），预签名有效期控制，最小权限的存储账号
- **可观测性**：Spring Actuator 健康检查、指标暴露

## 待补充

- 监控指标定义与报警策略
- 详细缓存失效策略与一致性处理
- 插件执行模型（同步/异步、重试）
- 切面模块详细设计（可见性、审计）
- 领域层实体与应用层 DTO 的映射策略
