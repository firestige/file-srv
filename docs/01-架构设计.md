# 架构设计

## 总览

ICC File Service 采用 **领域驱动设计（DDD）** 分层架构，结合适配器模式，通过 Spring Boot 自动装配加载存储后端，持久化元数据与任务状态，利用 Redis 做缓存，满足无状态横向扩容。

## DDD 分层架构

### 整体结构

```
┌─────────────────────────────────────────────────────────────────┐
│                       file-srv-core                             │
├─────────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────────┐  │
│  │              应用层 (application/)                         │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │  entrypoint/                                        │  │  │
│  │  │    ├── FileController      (文件操作 REST API)       │  │  │
│  │  │    ├── TaskController      (上传任务 REST API)       │  │  │
│  │  │    ├── StaticResourceController (静态资源访问)        │  │  │
│  │  │    └── model/              (请求/响应 DTO)           │  │  │
│  │  │         ├── FileInfo                                │  │  │
│  │  │         ├── TaskInfo                                │  │  │
│  │  │         ├── MetaQueryParams                         │  │  │
│  │  │         └── PartUploadInfo                          │  │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │  service/                                           │  │  │
│  │  │    ├── FileService         (文件应用服务)            │  │  │
│  │  │    └── TaskService         (任务应用服务)            │  │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │              领域层 (domain/)                              │  │
│  │    ├── files/                                             │  │
│  │    │    ├── FileAggregate     (文件聚合根)                 │  │
│  │    │    └── FileInfo          (文件领域实体)               │  │
│  │    └── tasks/                                             │  │
│  │         ├── TaskAggregate     (任务聚合根)                 │  │
│  │         ├── TaskInfo          (任务领域实体)               │  │
│  │         └── TaskStatus        (任务状态枚举)               │  │
│  └───────────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │              基础设施层 (infra/)                           │  │
│  │    ├── storage/                                           │  │
│  │    │    └── StorageAdapter    (存储适配器接口)             │  │
│  │    └── plugin/                                            │  │
│  │         └── SharedPlugin      (插件接口)                   │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

### 分层职责

| 层级 | 包路径 | 职责 |
|-----|--------|------|
| **应用层** | `application/` | 编排领域对象完成用例，暴露 REST API，DTO 转换 |
| **领域层** | `domain/` | 核心业务逻辑，聚合根、实体、值对象、领域服务 |
| **基础设施层** | `infra/` | 技术实现接口定义（存储、插件），具体实现在外部模块 |

## 模块依赖关系

```
                    ┌─────────────────────┐
                    │   file-srv-test     │  (集成测试)
                    └──────────┬──────────┘
                               │
                    ┌──────────▼──────────┐
                    │ file-srv-autoconfig │  (Spring 自动装配)
                    └──────────┬──────────┘
                               │
        ┌──────────────────────┼──────────────────────┐
        │                      │                      │
┌───────▼───────┐   ┌─────────▼─────────┐   ┌───────▼───────┐
│file-srv-aspect│   │  file-srv-adapters │   │file-srv-plugins│
│  (切面模块)    │   │   (存储适配器)      │   │   (插件模块)   │
└───────┬───────┘   └─────────┬─────────┘   └───────┬───────┘
        │                     │                     │
        └─────────────────────┼─────────────────────┘
                              │
                    ┌─────────▼─────────┐
                    │   file-srv-core   │  (核心模块)
                    └─────────┬─────────┘
                              │
                    ┌─────────▼─────────┐
                    │  file-srv-common  │  (公共模块，无依赖)
                    └───────────────────┘
```

## 关键设计点

- **DDD 分层**：领域逻辑集中在 `domain/`，应用编排在 `application/`，技术细节在 `infra/` 及外部模块
- **无状态服务**：会话/任务状态不落本地，依赖 DB + Redis，可水平扩容
- **多级缓存**：Caffeine 进程内热点 + Redis 分布式缓存，降低 DB/存储访问
- **配置驱动适配器加载**：`storage.obs.enabled=true` 触发华为云适配器自动装配
- **统一异常**：SDK/IO 异常转换为 `FileServiceException`，错误码集中在 `ResultCode`
- **插件机制**：上传完成后按顺序调用 `SharedPlugin` 实现后处理扩展
- **可观察性**：Spring Actuator 做健康检查、指标暴露

## 数据流

### 1. 同步上传
```
FileController.uploadFile()
    ↓
FileService.upload()
    ↓
StorageAdapter.uploadFile()  ──→  对象存储 (OBS/OSS/S3...)
    ↓
MetaService.save()  ──→  DB (FileEntity)
    ↓
返回 FileInfo
```

### 2. 分片上传
```
TaskController.createUploadTask()
    ↓
TaskService.create()  ──→  DB (TaskEntity) + Redis (状态缓存)
    ↓
StorageAdapter.initiateMultipartUpload()
    ↓
返回 TaskInfo (含 uploadId)

TaskController.uploadPart()
    ↓
TaskService.recordPart()
    ↓
StorageAdapter.uploadPart()
    ↓
返回 PartUploadInfo (含 eTag)

TaskController.completeUpload()
    ↓
StorageAdapter.completeMultipartUpload()
    ↓
SharedPlugin.apply() × N  (按顺序执行插件)
    ↓
MetaService.save()  ──→  DB (FileEntity)
    ↓
TaskService.complete()  ──→  更新状态
```

### 3. 下载
```
FileController.getFile() / StaticResourceController.staticResource()
    ↓
MetaService.findByFkey()  ←──  Caffeine → Redis → DB
    ↓
StorageAdapter.downloadFile()  或  generatePresignedUrl()
    ↓
返回 Resource / 重定向 URL
```

### 4. 删除
```
FileController.deleteFile()
    ↓
StorageAdapter.deleteFile()  ──→  删除对象存储文件
    ↓
MetaService.delete()  ──→  删除 DB 记录
    ↓
缓存失效  ──→  删除 Redis/Caffeine 缓存
```

## 组件交互示意

```
┌─────────────────────────────────────────────────────────────────┐
│                         应用层                                   │
│  FileController ─┬─→ FileService ─┬─→ StorageAdapter (接口)      │
│  TaskController ─┤                │                             │
│  StaticResource ─┘                └─→ MetaService (待实现)       │
│                                       TaskService (待实现)       │
└───────────────────────────┬─────────────────────────────────────┘
                            │
┌───────────────────────────▼─────────────────────────────────────┐
│                         领域层                                   │
│  FileAggregate ←──────────────────────→ TaskAggregate           │
│       │                                       │                  │
│  FileInfo (实体)                        TaskInfo (实体)          │
│                                         TaskStatus (枚举)        │
└───────────────────────────┬─────────────────────────────────────┘
                            │
┌───────────────────────────▼─────────────────────────────────────┐
│                       基础设施层                                 │
│                                                                  │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │ StorageAdapter  │  │  SharedPlugin   │  │   Repository    │  │
│  │    (接口)       │  │    (接口)       │  │    (JPA)        │  │
│  └────────┬────────┘  └────────┬────────┘  └─────────────────┘  │
└───────────┼────────────────────┼────────────────────────────────┘
            │ (实现在外部模块)     │ (实现在外部模块)
┌───────────▼───────────┐  ┌─────▼─────────────────┐
│   file-srv-adapters   │  │    file-srv-plugins   │
│  ┌─────────────────┐  │  │  ┌─────────────────┐  │
│  │ HcsObsAdapter   │  │  │  │ RenamePlugin    │  │
│  │ (华为云OBS)     │  │  │  │ (示例)          │  │
│  └─────────────────┘  │  │  └─────────────────┘  │
└───────────────────────┘  └───────────────────────┘
```

## 配置示例

```yaml
# 存储配置
storage:
  obs:
    enabled: true
    endpoint: https://obs.cn-north-4.myhuaweicloud.com
    bucket-name: ${OBS_BUCKET}
    access-key: ${OBS_ACCESS_KEY}
    secret-key: ${OBS_SECRET_KEY}
    presigned-url-expiration: 3600s

# Redis 配置
spring:
  redis:
    host: localhost
    port: 6379
  datasource:
    url: jdbc:mysql://localhost:3306/filesrv
    username: root
    password: ${DB_PASSWORD}
```

## 非功能性目标

- **可扩展性**：适配器接口稳定，新增存储零侵入业务层；插件机制支持后处理扩展
- **可靠性**：分片上传支持重试、幂等；任务状态可恢复
- **性能**：多级缓存、直连预签名下载、分片并发上传
- **安全**：凭证隔离（配置/环境变量），预签名有效期控制，最小权限的存储账号
- **可观测性**：Spring Actuator 健康检查、指标暴露

## 待补充

- 监控指标定义与报警策略
- 详细缓存失效策略与一致性处理
- 插件执行模型（同步/异步、重试）
- 切面模块详细设计（可见性、审计）
